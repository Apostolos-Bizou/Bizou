<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î¹Î¿">
    <meta name="theme-color" content="#2E7D32">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î¹Î¿">
    <title>Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î¹Î¿ - ÎœÏ€Î¯Î¶Î¿Ï…</title>
    
    <!-- PWA Manifest - Inline -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoizpLOsc64zrzOv867z4zOs865zr8gLSDOnM+Azq/Ots6/z4UiLCJzaG9ydF9uYW1lIjoizpLOsc64zrzOv867z4zOs865zr8iLCJkZXNjcmlwdGlvbiI6Is6Vz4bOsc+BzrzOv86zzq4gzrrOsc+EzrHPh8+Oz4HOuc+DzrfPgiDOus6xzrkgzrHOvc6xz4bOv8+Bz47OvSDOss6xzrjOvM6/zrvOv86zzq/Osc+CLiIsInN0YXJ0X3VybCI6Ii4vIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI0ZBRkFGQyIsInRoZW1lX2NvbG9yIjoiIzVCMkM4MyIsImljb25zIjpbXX0=">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%235B2C83' rx='40'/><text x='90' y='115' font-size='80' text-anchor='middle' fill='white'>âœï¸</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2E7D32;
            --primary-light: #4CAF50;
            --primary-dark: #1B5E20;
            --primary-gradient: linear-gradient(135deg, #4CAF50 0%, #2E7D32 50%, #1B5E20 100%);
            --accent: #E8F5E9;
            --accent-light: #F1F8E9;
            --success: #2ECC71;
            --warning: #F39C12;
            --danger: #E74C3C;
            --text-primary: #1A1A2E;
            --text-secondary: #6B7280;
            --text-light: #9CA3AF;
            --bg-main: #FAFAFC;
            --bg-card: #FFFFFF;
            --shadow-sm: 0 2px 8px rgba(91, 44, 131, 0.08);
            --shadow-md: 0 4px 20px rgba(91, 44, 131, 0.12);
            --shadow-lg: 0 8px 40px rgba(91, 44, 131, 0.16);
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-full: 50px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* App Container */
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Header */
        .app-header {
            background: var(--primary-gradient);
            padding: 16px 20px;
            padding-top: calc(16px + env(safe-area-inset-top));
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .app-title {
            color: white;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .app-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .header-btn:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.25);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            padding-bottom: calc(100px + env(safe-area-inset-bottom));
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px 12px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
            font-weight: 500;
        }

        /* Section Title */
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 4px;
        }

        /* Form Card */
        .form-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-md);
            margin-bottom: 20px;
        }

        /* Dropdown Select */
        .select-group {
            margin-bottom: 16px;
        }

        .select-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .select-wrapper {
            position: relative;
        }

        .custom-select {
            width: 100%;
            padding: 14px 44px 14px 16px;
            font-size: 16px;
            font-family: inherit;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--accent-light);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            appearance: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .custom-select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(91, 44, 131, 0.1);
        }

        .select-arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--primary);
            font-size: 18px;
        }

        .date-input {
            width: 100%;
            color-scheme: light;
        }

        .date-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
        }

        /* Score Input */
        .score-section {
            background: var(--accent-light);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 16px;
        }

        /* Scale Toggle */
        .scale-toggle {
            display: flex;
            gap: 12px;
        }

        .scale-btn {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-md);
            border: 2px solid var(--accent);
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .scale-btn .scale-number {
            display: block;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .scale-btn .scale-desc {
            display: block;
            font-size: 11px;
            color: var(--text-light);
            margin-top: 2px;
        }

        .scale-btn.active {
            border-color: var(--primary);
            background: var(--accent-light);
        }

        .scale-btn.active .scale-number {
            color: var(--primary);
        }

        .scale-btn:active {
            transform: scale(0.98);
        }

        .score-display {
            text-align: center;
            margin-bottom: 16px;
        }

        .score-value {
            font-size: 64px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .score-max {
            font-size: 24px;
            color: var(--text-light);
            font-weight: 500;
        }

        .score-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--accent);
            appearance: none;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .score-slider::-webkit-slider-thumb {
            appearance: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-gradient);
            box-shadow: var(--shadow-md);
            cursor: pointer;
        }

        .quick-scores {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-score-btn {
            padding: 8px 16px;
            border-radius: var(--radius-full);
            border: 2px solid var(--accent);
            background: white;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-score-btn:active,
        .quick-score-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Notes Textarea */
        .notes-group {
            margin-bottom: 16px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 14px 16px;
            font-size: 16px;
            font-family: inherit;
            color: var(--text-primary);
            background: var(--accent-light);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            resize: vertical;
            transition: all 0.2s ease;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(91, 44, 131, 0.1);
        }

        .notes-textarea::placeholder {
            color: var(--text-light);
        }

        /* Phrase Chips */
        .phrase-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .phrase-chip {
            padding: 8px 14px;
            border-radius: var(--radius-full);
            background: white;
            border: 1px solid var(--accent);
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .phrase-chip:active {
            background: var(--accent);
            border-color: var(--primary-light);
            color: var(--primary);
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 18px;
            border-radius: var(--radius-md);
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-size: 18px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-btn:active {
            transform: scale(0.98);
            box-shadow: var(--shadow-sm);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Selected Student Banner */
        .selected-student-banner {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            background: var(--primary-gradient);
            padding: 12px 20px;
            text-align: center;
            z-index: 99;
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 -4px 20px rgba(91, 44, 131, 0.3);
        }

        .selected-student-banner.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .selected-student-name {
            color: white;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .selected-student-class {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            margin-top: 2px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            padding: 12px 20px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            background: transparent;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-item.active {
            color: var(--primary);
            background: var(--accent-light);
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            width: 100%;
            max-height: 85vh;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            padding: 24px 20px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: var(--accent);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        /* Grade History List */
        .grade-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .grade-item {
            background: var(--accent-light);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .grade-score-badge {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-sm);
            background: var(--primary-gradient);
            color: white;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grade-details {
            flex: 1;
        }

        .grade-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-left: 10px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: #E8F4FD;
        }

        .edit-btn:active {
            background: #B8DCFA;
        }

        .delete-btn {
            background: #FDEEEE;
        }

        .delete-btn:active {
            background: #FABDBD;
        }

        /* Student Card Styles */
        .student-card-header {
            background: var(--primary-gradient);
            color: white;
            padding: 15px;
            border-radius: var(--radius-md);
            margin-bottom: 15px;
            text-align: center;
        }

        .student-card-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .student-card-class {
            font-size: 12px;
            opacity: 0.9;
        }

        .subject-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .subject-header {
            background: var(--accent-light);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .subject-name {
            font-weight: 600;
            color: var(--primary);
        }

        .subject-avg {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .subject-grades {
            padding: 10px 15px;
        }

        .category-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .category-row:last-child {
            border-bottom: none;
        }

        .category-name {
            font-size: 12px;
            color: var(--text-secondary);
            flex: 1;
        }

        .category-grades {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .grade-chip {
            background: var(--accent-light);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .grade-chip-score {
            font-weight: 600;
            color: var(--primary);
        }

        .grade-chip-date {
            color: var(--text-light);
            font-size: 9px;
        }

        .final-grade-row {
            background: var(--accent-light);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .final-grade-label {
            font-weight: 600;
            color: var(--primary);
        }

        .final-grade-input {
            width: 70px;
            padding: 8px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            color: var(--primary);
        }

        .final-grade-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(91, 44, 131, 0.2);
        }

        .save-finals-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 15px;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-top: 15px;
            cursor: pointer;
        }

        .save-finals-btn:active {
            transform: scale(0.98);
        }

        /* Period Sections */
        .period-section {
            border-bottom: 1px solid var(--border);
        }

        .period-section:last-of-type {
            border-bottom: none;
        }

        .period-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f5fc;
        }

        .period-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: 0.5px;
        }

        .period-avg {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .period-grades {
            padding: 8px 15px;
        }

        .grades-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .no-grades-text {
            text-align: center;
            color: #ccc;
            font-size: 11px;
            padding: 8px;
        }

        .period-final {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #faf8fc;
            font-size: 12px;
            font-weight: 500;
        }

        .final-grade-input.small {
            width: 60px;
            padding: 6px;
            font-size: 14px;
        }

        /* Exam Section */
        .exam-section {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
        }

        .exam-header {
            background: transparent !important;
        }

        .exam-score {
            font-size: 20px;
            font-weight: 700;
            color: #856404;
        }

        /* Year Final Section */
        .year-final-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--primary-gradient);
        }

        .year-final-label {
            font-size: 12px;
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
        }

        .final-grade-input.large {
            width: 80px;
            padding: 10px;
            font-size: 18px;
            background: white;
        }

        .grade-student {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .grade-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Reports View */
        .report-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: var(--accent-light);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .report-btn:active {
            border-color: var(--primary);
            background: white;
        }

        .report-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-sm);
            background: var(--primary-gradient);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .report-info h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .report-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--primary-dark);
            color: white;
            padding: 14px 24px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 300;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* View Transitions */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 16px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>

<script>
  // Prevent duplicate sync calls (double-click, mobile ghost taps)
  const __inFlightSync = new Set();
(function () {
  // --- Frontend PIN lock (locks again when you leave / background the app) ---
  const PIN = "4775";
  const KEY = "bizou_pin_session_ok"; // session-only

  function deny(msg) {
    try { alert(msg); } catch (e) {}
    document.documentElement.innerHTML = "";
    throw new Error(msg);
  }

  // If already unlocked for this browser session/tab, do nothing.
  if (sessionStorage.getItem(KEY) === "1") return;

  const entered = prompt("ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚:");
  if (entered === null) {
    // Cancel must NOT allow access.
    deny("Î‘ÎºÏÏÏ‰ÏƒÎ· â€” Î´ÎµÎ½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·.");
  }

  if (String(entered).trim() !== String(PIN).trim()) {
    deny("Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚.");
  }

  sessionStorage.setItem(KEY, "1");

  // Lock again when the page is being hidden/closed (practical 'exit' for mobile)
  function relock() {
    try { sessionStorage.removeItem(KEY); } catch (e) {}
  }

  // When the tab/app is backgrounded
  document.addEventListener("visibilitychange", function () {
    if (document.hidden) relock();
  });

  // When navigating away / closing / reload
  window.addEventListener("pagehide", relock);
  window.addEventListener("beforeunload", relock);
})();
</script>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-logo">
                    <div class="logo-icon">ğŸ“š</div>
                    <div>
                        <div class="app-title">ğŸ§ª STAGING</div>
                        <div class="app-subtitle">ÎœÎ¿Ï…ÏƒÎ¹ÎºÏŒ Î£Ï‡Î¿Î»ÎµÎ¯Î¿ Î›ÎµÏ…ÎºÎ¬Î´Î±Ï‚</div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="syncToGoogleSheets()" title="Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚">â˜ï¸</button>
                    <button class="header-btn" onclick="showReports()">ğŸ“„</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Grading View -->
            <div id="grading-view" class="view active">
                <!-- Quick Stats - Dynamic -->
                <div class="quick-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="class-avg">-</div>
                        <div class="stat-label">Îœ.ÎŸ. Î¤Î¬Î¾Î·Ï‚</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="student-avg">-</div>
                        <div class="stat-label">Îœ.ÎŸ. ÎœÎ±Î¸Î·Ï„Î®</div>
                    </div>
                </div>

                <!-- Grading Form -->
                <div class="form-card">
                    <div class="section-title">ÎÎ­Î± Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·</div>
                    
                    <!-- Class Select -->
                    <div class="select-group">
                        <label class="select-label">Î¤Î¬Î¾Î·</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="class-select" onchange="updateStudents()">
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·...</option>
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>

                    <!-- Student Select -->
                    <div class="select-group">
                        <label class="select-label">ÎœÎ±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î±</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="student-select" disabled onchange="updateStudentBanner()">
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÏÏ„Î± Ï„Î¬Î¾Î·...</option>
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>

                    <!-- Subject Select -->
                    <div class="select-group">
                        <label class="select-label">ÎœÎ¬Î¸Î·Î¼Î±</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="subject-select" onchange="updateLiveStats()">
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î¬Î¸Î·Î¼Î±...</option>
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>

                    <!-- Category Select -->
                    <div class="select-group">
                        <label class="select-label">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="category-select" onchange="updateLiveStats()">
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±...</option>
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>

                    <!-- Date Picker -->
                    <div class="select-group">
                        <label class="select-label">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚</label>
                        <input type="date" class="custom-select date-input" id="grade-date" style="padding-right: 15px;">
                    </div>

                    <!-- Scale Selection (Only for Lyceum) -->
                    <div class="select-group" id="scale-selection" style="display: none;">
                        <label class="select-label">ÎšÎ»Î¯Î¼Î±ÎºÎ± Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚</label>
                        <div class="scale-toggle">
                            <button class="scale-btn active" id="scale-20-btn" onclick="setScale(20)">
                                <span class="scale-number">0-20</span>
                                <span class="scale-desc">Î•Î¹ÎºÎ¿ÏƒÎ±Î²Î¬Î¸Î¼Î¹Î±</span>
                            </button>
                            <button class="scale-btn" id="scale-100-btn" onclick="setScale(100)">
                                <span class="scale-number">0-100</span>
                                <span class="scale-desc">Î•ÎºÎ±Ï„Î¿Î½Ï„Î±Î²Î¬Î¸Î¼Î¹Î±</span>
                            </button>
                        </div>
                    </div>

                    <!-- Score Section - Scale 20 -->
                    <div class="score-section" id="score-section-20">
                        <div class="score-display">
                            <span class="score-value" id="score-display-20">10</span>
                            <span class="score-max">/20</span>
                        </div>
                        <input type="range" class="score-slider" id="score-slider-20" 
                               min="0" max="20" step="0.5" value="10"
                               oninput="updateScore20(this.value)">
                        <div class="quick-scores">
                            <button class="quick-score-btn" onclick="setScore20(5)">5</button>
                            <button class="quick-score-btn" onclick="setScore20(10)">10</button>
                            <button class="quick-score-btn" onclick="setScore20(12)">12</button>
                            <button class="quick-score-btn" onclick="setScore20(15)">15</button>
                            <button class="quick-score-btn" onclick="setScore20(18)">18</button>
                            <button class="quick-score-btn" onclick="setScore20(20)">20</button>
                        </div>
                    </div>

                    <!-- Score Section - Scale 100 (Hidden by default) -->
                    <div class="score-section" id="score-section-100" style="display: none;">
                        <div class="score-display">
                            <span class="score-value" id="score-display-100">50</span>
                            <span class="score-max">/100</span>
                        </div>
                        <input type="range" class="score-slider" id="score-slider-100" 
                               min="0" max="100" step="0.5" value="50"
                               oninput="updateScore100(this.value)">
                        <div class="quick-scores">
                            <button class="quick-score-btn" onclick="setScore100(25)">25</button>
                            <button class="quick-score-btn" onclick="setScore100(50)">50</button>
                            <button class="quick-score-btn" onclick="setScore100(60)">60</button>
                            <button class="quick-score-btn" onclick="setScore100(75)">75</button>
                            <button class="quick-score-btn" onclick="setScore100(85)">85</button>
                            <button class="quick-score-btn" onclick="setScore100(100)">100</button>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="notes-group">
                        <label class="select-label">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î® / Î£Ï‡ÏŒÎ»Î¹Î±</label>
                        <textarea class="notes-textarea" id="notes-input" 
                                  placeholder="Î“ÏÎ¬ÏˆÏ„Îµ Ï„Î± ÏƒÏ‡ÏŒÎ»Î¹Î¬ ÏƒÎ±Ï‚ ÎµÎ´Ï..."></textarea>
                        <div class="phrase-chips" id="phrase-chips">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Submit -->
                    <button class="submit-btn" id="submit-btn" onclick="saveGrade()">
                        <span>ğŸ’¾</span>
                        <span>Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î’Î±Î¸Î¼Î¿Ï</span>
                    </button>
                </div>

                <!-- Recent Grades -->
                <div class="section-title">Î ÏÏŒÏƒÏ†Î±Ï„ÎµÏ‚ Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î®ÏƒÎµÎ¹Ï‚</div>
                <div class="grade-list" id="recent-grades">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <div class="empty-text">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î®ÏƒÎµÎ¹Ï‚ Î±ÎºÏŒÎ¼Î±</div>
                    </div>
                </div>
            </div>

            <!-- History View -->
            <div id="history-view" class="view">
                <div class="section-title">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î’Î±Î¸Î¼ÏÎ½</div>
                <div class="form-card">
                    <div class="select-group">
                        <label class="select-label">Î¦Î¯Î»Ï„ÏÎ¿ Î¤Î¬Î¾Î·Ï‚</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="history-class-filter" onchange="filterHistory()">
                                <option value="">ÎŒÎ»ÎµÏ‚ Î¿Î¹ Ï„Î¬Î¾ÎµÎ¹Ï‚</option>
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                </div>
                <div class="grade-list" id="history-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Student Card View -->
            <div id="student-card-view" class="view">
                <div class="section-title">ÎšÎ±ÏÏ„Î­Î»Î± ÎœÎ±Î¸Î·Ï„Î®</div>
                <div class="form-card">
                    <div class="select-group">
                        <label class="select-label">Î¤Î¬Î¾Î·</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="card-class" onchange="updateCardStudents()">
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·...</option>
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                    <div class="select-group">
                        <label class="select-label">ÎœÎ±Î¸Î·Ï„Î®Ï‚</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="card-student" onchange="loadStudentCard()" disabled>
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÏÏ„Î± Ï„Î¬Î¾Î·...</option>
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                </div>
                
                <!-- Student Card Content -->
                <div id="student-card-content">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘¤</div>
                        <div class="empty-text">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î±Î¸Î·Ï„Î® Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ ÎºÎ±ÏÏ„Î­Î»Î± Ï„Î¿Ï…</div>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reports-view" class="view">
                <div class="section-title">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î‘Î½Î±Ï†Î¿ÏÏÎ½ PDF</div>
                <div class="report-options">
                    <button class="report-btn" onclick="generateReport('student')">
                        <div class="report-icon">ğŸ‘¤</div>
                        <div class="report-info">
                            <h3>Î‘Ï„Î¿Î¼Î¹ÎºÏŒ Î”ÎµÎ»Ï„Î¯Î¿ ÎœÎ±Î¸Î·Ï„Î®</h3>
                            <p>Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Î±Î½Î±Ï†Î¿ÏÎ¬ Î³Î¹Î± ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ Î¼Î±Î¸Î·Ï„Î®</p>
                        </div>
                    </button>
                    <button class="report-btn" onclick="generateReport('studentGrid')">
                        <div class="report-icon">ğŸ‘¤</div>
                        <div class="report-info">
                            <h3>Î‘Ï„Î¿Î¼Î¹ÎºÏŒ Î”ÎµÎ»Ï„Î¯Î¿ (Landscape)</h3>
                            <p>Î Î¯Î½Î±ÎºÎ±Ï‚ Î¼Î±Î¸Î·Ï„Î® Î¼Îµ ÏŒÎ»Î± Ï„Î± Î¼Î±Î¸Î®Î¼Î±Ï„Î± & ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</p>
                        </div>
                    </button>
                    <button class="report-btn" onclick="generateReport('studentFinal')">
                        <div class="report-icon">âœ…</div>
                        <div class="report-info">
                            <h3>ÎšÎ±ÏÏ„Î­Î»Î± ÎœÎ±Î¸Î·Ï„Î® - Î¤ÎµÎ»Î¹ÎºÎ¿Î¯ Î’Î±Î¸Î¼Î¿Î¯</h3>
                            <p>Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· Ï„ÎµÎ»Î¹ÎºÏÎ½ Î²Î±Î¸Î¼ÏÎ½ Î¼Î±Î¸Î·Ï„Î® (Î±Î½Î¬ Î¼Î¬Î¸Î·Î¼Î±)</p>
                        </div>
                    </button>
                    <button class="report-btn" onclick="generateReport('class')">
                        <div class="report-icon">ğŸ“Š</div>
                        <div class="report-info">
                            <h3>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¤Î¬Î¾Î·Ï‚</h3>
                            <p>Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ® Î±Î½Î±Ï†Î¿ÏÎ¬ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î¼Î±Î¸Î·Ï„ÏÎ½</p>
                        </div>
                    </button>
                    <button class="report-btn" onclick="generateReport('classGrid')">
                        <div class="report-icon">ğŸ“‹</div>
                        <div class="report-info">
                            <h3>Î Î¯Î½Î±ÎºÎ±Ï‚ Î¤Î¼Î®Î¼Î±Ï„Î¿Ï‚ (Landscape)</h3>
                            <p>Î‘Î»Ï†Î±Î²Î·Ï„Î¹ÎºÎ¬ Î¼Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚ Î²Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚</p>
                        </div>
                    </button>
                    <button class="report-btn" onclick="generateReport('classFinal')">
                        <div class="report-icon">âœ…</div>
                        <div class="report-info">
                            <h3>ÎšÎ±ÏÏ„Î­Î»Î± Î‘Î½Î¬ Î¤Î¬Î¾Î· - Î¤ÎµÎ»Î¹ÎºÎ¿Î¯ Î’Î±Î¸Î¼Î¿Î¯</h3>
                            <p>Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÏŒÏ‚ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Ï„ÎµÎ»Î¹ÎºÏÎ½ Î²Î±Î¸Î¼ÏÎ½ Î±Î½Î¬ Ï„Î¼Î®Î¼Î±</p>
                        </div>
                    </button>
                    <button class="report-btn" onclick="generateReport('period')">
                        <div class="report-icon">ğŸ“…</div>
                        <div class="report-info">
                            <h3>Î‘Î½Î±Ï†Î¿ÏÎ¬ Î ÎµÏÎ¹ÏŒÎ´Î¿Ï…</h3>
                            <p>Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ ÎºÎ±Î¹ Î±Î½Î¬Î»Ï…ÏƒÎ· Ï„ÏÎ¹Î¼Î®Î½Î¿Ï…</p>
                        </div>
                    </button>
                </div>
            </div>
        </main>

        <!-- Selected Student Banner -->
        <div class="selected-student-banner" id="student-banner">
            <div class="selected-student-name" id="banner-student-name">-</div>
            <div class="selected-student-class" id="banner-class-name">-</div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="showView('grading')">
                <span class="nav-icon">âœï¸</span>
                <span class="nav-label">Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·</span>
            </button>
            <button class="nav-item" onclick="showView('student-card')">
                <span class="nav-icon">ğŸ‘¤</span>
                <span class="nav-label">ÎšÎ±ÏÏ„Î­Î»Î±</span>
            </button>
            <button class="nav-item" onclick="showView('history')">
                <span class="nav-icon">ğŸ“‹</span>
                <span class="nav-label">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ</span>
            </button>
            <button class="nav-item" onclick="showView('reports')">
                <span class="nav-icon">ğŸ“„</span>
                <span class="nav-label">Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚</span>
            </button>
        </nav>

        <!-- Toast -->
        <div class="toast" id="toast"></div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="report-modal">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <div class="modal-title" id="modal-title">Î•Ï€Î¹Î»Î¿Î³Î® ÎœÎ±Î¸Î·Ï„Î®</div>
            <div id="modal-body">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // ============== HYBRID OFFLINEâ†’SYNCâ†’CLEAR (mobile-safe) ==============
        const APP_BUILD = '2026-01-19-finalreports1-staging';
        const HYBRID_CLEAR_LOCAL_ON_FULL_SYNC = true;
        const LOCAL_GRADES_KEY = 'bizou_grades_staging';
        const LOCAL_SYNC_QUEUE_KEY = 'google_sync_queue_v1_staging';

        (function versionedWipe(){
            try {
                const prev = localStorage.getItem('bizou_app_build_staging');
                if (prev !== APP_BUILD) {
                    // New build detected: wipe local history + pending queue to avoid "ghost" entries
                    localStorage.removeItem(LOCAL_GRADES_KEY);
                    localStorage.removeItem(LOCAL_SYNC_QUEUE_KEY);
                    // Best-effort deep clean (mobile Chrome): IndexedDB + Cache Storage
                    try {
                        if (indexedDB && indexedDB.databases) {
                            indexedDB.databases().then(dbs => dbs.forEach(db => db && db.name && indexedDB.deleteDatabase(db.name)));
                        }
                    } catch (e) {}
                    try {
                        if (caches && caches.keys) {
                            caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
                        }
                    } catch (e) {}
                    localStorage.setItem('bizou_app_build_staging', APP_BUILD);
                }
            } catch(e) { /* ignore */ }
        })();

        // Helper for manual reset (optional): run in console: window.bizouHardReset()
        window.bizouHardReset = function(){
            try {
                localStorage.removeItem(LOCAL_GRADES_KEY);
                localStorage.removeItem(LOCAL_SYNC_QUEUE_KEY);
                localStorage.removeItem('bizou_access_ok');
                alert('ÎˆÎ³Î¹Î½Îµ ÎºÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï„Î¿Ï€Î¹ÎºÏÎ½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½. ÎšÎ¬Î½Îµ refresh.');
            } catch(e) {
                alert('Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± ÎºÎ±Î¸Î±ÏÎ¯ÏƒÏ‰ Ï„Î¿Ï€Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î±: ' + e);
            }
        };

        // ============== DATA ==============
        const SCHOOL_YEAR = '2025-2026';
        const classes = [
            { id: "A1_LYK_2025_2026", name: "Î‘1 Î›Î¥ÎšÎ•Î™ÎŸÎ¥ Î“Î•ÎÎ™ÎšÎ—Î£ Î Î‘Î™Î”Î•Î™Î‘Î£", year: "2025-2026" },
            { id: "A2_LYK_2025_2026", name: "Î‘2 Î›Î¥ÎšÎ•Î™ÎŸÎ¥ Î“Î•ÎÎ™ÎšÎ—Î£ Î Î‘Î™Î”Î•Î™Î‘Î£", year: "2025-2026" },
            { id: "A1_GYM_2025_2026", name: "Î‘1 Î“Î¥ÎœÎÎ‘Î£Î™ÎŸÎ¥ Î“Î•ÎÎ™ÎšÎ—Î£ Î Î‘Î™Î”Î•Î™Î‘Î£", year: "2025-2026" },
            { id: "A2_GYM_2025_2026", name: "Î‘2 Î“Î¥ÎœÎÎ‘Î£Î™ÎŸÎ¥ Î“Î•ÎÎ™ÎšÎ—Î£ Î Î‘Î™Î”Î•Î™Î‘Î£", year: "2025-2026" },
            { id: "B1_GYM_2025_2026", name: "Î’1 Î“Î¥ÎœÎÎ‘Î£Î™ÎŸÎ¥ Î“Î•ÎÎ™ÎšÎ—Î£ Î Î‘Î™Î”Î•Î™Î‘Î£", year: "2025-2026" },
            { id: "B2_GYM_2025_2026", name: "Î’2 Î“Î¥ÎœÎÎ‘Î£Î™ÎŸÎ¥ Î“Î•ÎÎ™ÎšÎ—Î£ Î Î‘Î™Î”Î•Î™Î‘Î£", year: "2025-2026" }
        ];

        const students = [
            { classId: "A2_GYM_2025_2026", regNo: "1216", name: "Î›ÎŸÎ“ÎŸÎ˜Î•Î¤Î— Î”Î—ÎœÎ—Î¤Î¡Î‘ - Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—" },
            { classId: "A2_GYM_2025_2026", regNo: "1231", name: "ÎœÎ‘ÎÎ¤Î–Î™ÎŸÎ£ Î§Î¡Î—Î£Î¤ÎŸÎ£" },
            { classId: "A2_GYM_2025_2026", regNo: "1203", name: "ÎœÎ‘Î¡Î“Î— Î‘Î“Î‘Î˜Î—" },
            { classId: "A2_GYM_2025_2026", regNo: "1204", name: "ÎœÎ•Î£Î£Î—ÎÎ—Î£ Î¦Î™Î›Î™Î Î ÎŸÎ£" },
            { classId: "A2_GYM_2025_2026", regNo: "1232", name: "ÎœÎ—Î›Î™Î©Î¤Î— Î§Î¡Î™Î£Î¤Î™ÎÎ‘" },
            { classId: "A2_GYM_2025_2026", regNo: "1243", name: "ÎœÎ Î‘Î›Î‘Î¤Î£ÎŸÎ¥Î¡Î‘Î£ Î”Î—ÎœÎ—Î¤Î¡Î™ÎŸÎ£" },
            { classId: "A2_GYM_2025_2026", regNo: "1205", name: "ÎœÎ Î‘Î¡Î™Î‘ÎœÎ—Î£ Î’Î‘Î£Î™Î›Î•Î™ÎŸÎ£" },
            { classId: "A2_GYM_2025_2026", regNo: "1213", name: "ÎœÎ Î•Î›Î•Î“Î¡Î™ÎÎŸÎ£ Î›ÎŸÎ¥ÎšÎ‘Î£" },
            { classId: "A2_GYM_2025_2026", regNo: "1220", name: "ÎœÎ Î•ÎÎÎ•Î¤ Î§Î‘Î¡Î¡Î¥ Î¤Î–ÎŸÎ¡Î¤Î–" },
            { classId: "A2_GYM_2025_2026", regNo: "1206", name: "ÎÎ™Î‘Î¦Î‘Î£ Î£Î Î¥Î¡Î™Î”Î©Î" },
            { classId: "A2_GYM_2025_2026", regNo: "1196", name: "Î Î‘Î›Î—ÎŸÎ“Î™Î‘ÎÎÎ— Î‘Î™ÎœÎ™Î›Î™Î‘-Î˜Î•ÎœÎ™Î£" },
            { classId: "A2_GYM_2025_2026", regNo: "1233", name: "Î Î‘Î Î‘Î”ÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ Î£Î©ÎšÎ¡Î‘Î¤Î—Î£" },
            { classId: "A2_GYM_2025_2026", regNo: "1214", name: "Î Î‘Î¤Î£Î™Î¡ÎŸÎ“Î™Î‘ÎÎÎ— Î’Î‘Î£Î™Î›Î™ÎšÎ—" },
            { classId: "A2_GYM_2025_2026", regNo: "1207", name: "Î Î•Î¤Î¡ÎŸÎ¥Î£Î— Î›Î¥Î”Î™Î‘" },
            { classId: "A2_GYM_2025_2026", regNo: "1208", name: "Î ÎŸÎ›Î™Î¤Î— Î§Î¡Î™Î£Î¤Î™ÎÎ‘" },
            { classId: "A2_GYM_2025_2026", regNo: "1234", name: "Î¡ÎŸÎœÎ ÎŸÎ¤Î— Î”Î•Î›Î™Î‘" },
            { classId: "A2_GYM_2025_2026", regNo: "1238", name: "Î£Î‘Î’Î’Î™Î”Î—Î£ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡ÎŸÎ£" },
            { classId: "A2_GYM_2025_2026", regNo: "1240", name: "Î£Î‘ÎœÎ¨Î©ÎÎ‘Î£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£" },
            { classId: "A2_GYM_2025_2026", regNo: "1209", name: "Î£Î‘Î¡Î‘ÎÎ¤Î™ÎÎŸÎ¥ Î‘ÎšÎ¡Î™Î’Î—" },
            { classId: "A2_GYM_2025_2026", regNo: "1210", name: "Î£ÎŸÎ›Î›Î‘Î¤ÎŸÎ¥ Î™Î©Î‘ÎÎÎ‘" },
            { classId: "A2_GYM_2025_2026", regNo: "1211", name: "Î¤Î–Î•Î’Î•Î›Î•ÎšÎ— ÎÎ•Î¦Î•Î›Î—" },
            { classId: "A2_GYM_2025_2026", regNo: "1215", name: "Î¤Î£Î‘ÎšÎÎ‘ÎšÎ—Î£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£" },
            { classId: "A2_GYM_2025_2026", regNo: "1239", name: "Î¤Î£Î™ÎŸÎÎ‘ÎšÎ‘ Î‘ÎÎ‘Î£Î¤Î‘Î£Î™Î‘" },
            { classId: "A2_GYM_2025_2026", regNo: "1235", name: "Î§Î‘ÎªÎ”Î‘ÎšÎ— ÎšÎ©ÎÎ£Î¤Î‘ÎÎ¤Î™ÎÎ‘" },
            { classId: "A1_GYM_2025_2026", regNo: "1221", name: "Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î™Î‘ ÎœÎ‘Î¡Î™Î‘" },
            { classId: "A1_GYM_2025_2026", regNo: "1222", name: "Î‘Î¡ÎšÎŸÎ¥ÎœÎ‘ÎÎ— Î§Î¡Î¥Î£ÎŸÎ¥Î›Î‘" },
            { classId: "A1_GYM_2025_2026", regNo: "1223", name: "Î‘Î¥Î“Î•Î¡Î™ÎÎŸÎ£ Î§Î¡Î—Î£Î¤ÎŸÎ£" },
            { classId: "A1_GYM_2025_2026", regNo: "1224", name: "Î“Î•Î™Î¤ÎŸÎÎ‘ Î–Î‘ÎœÎ Î™Î‘" },
            { classId: "A1_GYM_2025_2026", regNo: "1212", name: "Î“Î•Î©Î¡Î“Î‘ÎšÎ— Î–Î©Î—" },
            { classId: "A1_GYM_2025_2026", regNo: "1225", name: "Î”Î•Î£Î¥Î›Î›Î‘Î£ Î£Î Î¥Î¡Î™Î”Î©Î" },
            { classId: "A1_GYM_2025_2026", regNo: "1197", name: "Î–Î‘Î’Î™Î¤Î£Î‘ÎÎŸÎ£ Î£Î Î¥Î¡Î™Î”Î©Î - Î”Î™ÎŸÎÎ¥Î£Î™ÎŸÎ£" },
            { classId: "A1_GYM_2025_2026", regNo: "1241", name: "ÎšÎ‘Î›Î ÎŸÎ”Î—ÎœÎŸÎ£ Î£Î Î¥Î¡Î™Î”Î©Î" },
            { classId: "A1_GYM_2025_2026", regNo: "1226", name: "ÎšÎ‘Î¡Î‘Î“Î™Î‘ÎÎÎ—Î£ Î•Î Î‘ÎœÎ•Î™ÎÎ©ÎÎ”Î‘Î£" },
            { classId: "A1_GYM_2025_2026", regNo: "1227", name: "ÎšÎ‘Î¡Î‘ÎœÎ Î‘Î›Î— ÎœÎ‘Î¡Î™Î‘ Î Î‘ÎÎ‘Î“Î™Î©Î¤Î‘" },
            { classId: "A1_GYM_2025_2026", regNo: "1228", name: "ÎšÎ‘Î¡Î‘ÎœÎ Î‘Î›Î—Î£ Î¦Î™Î›Î™Î Î ÎŸÎ£" },
            { classId: "A1_GYM_2025_2026", regNo: "1242", name: "ÎšÎ‘Î¡Î›Î•Î£Î— Î™Î£Î‘ÎœÎ Î•Î›Î›Î‘-Î¦Î¡Î‘ÎÎ¤Î£Î•Î£ÎšÎ‘" },
            { classId: "A1_GYM_2025_2026", regNo: "1198", name: "ÎšÎ‘Î¡Î¥Î”Î—Î£ Î£Î©Î¤Î—Î¡Î™ÎŸÎ£ - Î’Î™ÎšÎ•ÎÎ¤Î™ÎŸÎ£" },
            { classId: "A1_GYM_2025_2026", regNo: "1199", name: "ÎšÎ‘Î£ÎŸÎ¥Î¡Î‘Î£ Î˜Î•ÎŸÎ”Î©Î¡ÎŸÎ£ - ÎÎ™ÎšÎŸÎ›Î‘ÎŸÎ£" },
            { classId: "A1_GYM_2025_2026", regNo: "1229", name: "ÎšÎ‘Î¤Î©Î ÎŸÎ”Î— Î™Î©Î‘ÎÎÎ‘" },
            { classId: "A1_GYM_2025_2026", regNo: "1200", name: "ÎšÎ‘Î¤Î©Î ÎŸÎ”Î—Î£ Î‘ÎÎ¤Î©ÎÎ™ÎŸÎ£" },
            { classId: "A1_GYM_2025_2026", regNo: "1230", name: "ÎšÎŸÎ›Î›ÎŸÎšÎ‘ Î‘Î¡Î™Î‘Î”ÎÎ—" },
            { classId: "A1_GYM_2025_2026", regNo: "1201", name: "ÎšÎŸÎ›Î›ÎŸÎšÎ‘Î£ Î”Î—ÎœÎ—Î¤Î¡Î™ÎŸÎ£" },
            { classId: "A1_GYM_2025_2026", regNo: "1237", name: "ÎšÎŸÎÎ¤ÎŸÎ£ Î‘ÎÎ”Î¡Î•Î‘Î£-ÎœÎ‘ÎÎ™ÎœÎŸÎ£" },
            { classId: "A1_GYM_2025_2026", regNo: "1202", name: "ÎšÎ¡Î—Î¤Î™ÎšÎŸÎ¥ Î£ÎŸÎ¦Î™Î‘" },
            { classId: "A1_GYM_2025_2026", regNo: "1217", name: "ÎšÎ©Î›Î•Î¤Î£Î—Î£ Î•ÎšÎ¤ÎŸÎ¡Î‘Î£" },
            { classId: "A1_GYM_2025_2026", regNo: "1218", name: "Î›Î™ÎŸÎ”Î‘ÎšÎ—Î£ Î‘Î“Î“Î•Î›ÎŸÎ£" },
            { classId: "A1_GYM_2025_2026", regNo: "1219", name: "ÎœÎ‘ÎÎ©Î›Î™Î¤Î£Î— Î¦Î™Î›Î™Î Î Î‘ - Î”Î•Î£Î ÎŸÎ™ÎÎ‘" },
            { classId: "A1_GYM_2025_2026", regNo: "1236", name: "ÎœÎ™ÎšÎ¡Î©ÎÎ— ÎšÎŸÎ¥Î¡Î¤Î— Î›Î¥Î”Î™Î‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1151", name: "Î‘ÎÎ¤Î¡Î•Î‘ Î£ÎŸÎ¦Î™Î‘ - Î’Î‘ÎÎ•Î£Î‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1152", name: "Î‘Î¡Î“Î¥Î¡ÎŸÎ¥ Î“Î•Î©Î¡Î“Î™Î‘ - Î§Î‘Î¡Î‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1153", name: "Î‘Î¡ÎœÎ‘Î¤Î‘Î£ ÎœÎ‘Î¡Î™ÎŸ - Î¤Î•Î¡Î™" },
            { classId: "B1_GYM_2025_2026", regNo: "1154", name: "Î’Î‘Î£Î™ÎŸÎ¥ Î”Î—ÎœÎ—Î¤Î¡Î‘ Î•Î¥Î‘Î“Î“Î•Î›Î™Î‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1155", name: "Î’Î•Î¡Î“Î™ÎÎ— Î˜Î•Î©ÎÎ— - ÎœÎ‘Î¡Î™Î‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1156", name: "Î“Î‘Î›Î‘ÎÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£" },
            { classId: "B1_GYM_2025_2026", regNo: "1157", name: "Î“Î™Î‘ÎÎÎŸÎ ÎŸÎ¥Î›ÎŸÎ¥ Î¦Î‘Î™Î”Î¡Î‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1158", name: "Î“Î¡Î‘Î¨Î‘ Î•Î¥Î¡Î¥Î”Î™ÎšÎ— Î•Î›Î•ÎÎ—" },
            { classId: "B1_GYM_2025_2026", regNo: "1161", name: "Î”Î‘ÎœÎ™Î‘ÎÎ—Î£ ÎšÎ©ÎÎ£Î¤Î‘ÎÎ¤Î™ÎÎŸÎ£" },
            { classId: "B1_GYM_2025_2026", regNo: "1162", name: "Î–Î‘Î’Î™Î¤Î£Î‘ÎÎŸÎ¥ Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—" },
            { classId: "B1_GYM_2025_2026", regNo: "1163", name: "Î˜Î•Î™Î‘ÎšÎŸÎ¥ Î‘Î™ÎšÎ‘Î¤Î•Î¡Î™ÎÎ— - ÎœÎ‘Î¡Î“Î‘Î¡Î™Î¤Î‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1164", name: "ÎšÎ‘Î’Î’Î‘Î”Î‘Î£ Î”Î—ÎœÎ—Î¤Î¡Î™ÎŸÎ£" },
            { classId: "B1_GYM_2025_2026", regNo: "1166", name: "ÎšÎ‘Î¤Î‘Î“Î— Î™Î©Î‘ÎÎÎ‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1167", name: "ÎšÎ‘Î¤Î©Î ÎŸÎ”Î— Î‘Î™ÎšÎ‘Î¤Î•Î¡Î™ÎÎ—" },
            { classId: "B1_GYM_2025_2026", regNo: "1168", name: "ÎšÎ‘Î¤Î©Î ÎŸÎ”Î— Î“Î•Î©Î¡Î“Î™Î‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1169", name: "ÎšÎ‘Î¦Î•ÎÎ¤Î–Î—Î£ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡ÎŸÎ£" },
            { classId: "B1_GYM_2025_2026", regNo: "1170", name: "ÎšÎ¥Î¡Î©Î£Î—Î£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£ Î‘Î¡Î—Î£" },
            { classId: "B1_GYM_2025_2026", regNo: "1171", name: "ÎœÎ‘Î£ÎŸÎ¥Î¡Î— ÎœÎ‘Î¡Î™Î‘ Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—" },
            { classId: "B1_GYM_2025_2026", regNo: "1174", name: "ÎœÎ•Î¤Î‘Î›Î™ÎÎŸÎ¥ Î£Î¤Î‘ÎœÎ‘Î¤Î™ÎÎ‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1194", name: "Î¤Î–Î‘ÎÎ™ÎÎ— ÎšÎ‘Î¡ÎŸÎ›Î™ÎÎ‘" },
            { classId: "B1_GYM_2025_2026", regNo: "1195", name: "Î§Î¡Î™Î£Î¤ÎŸÎ¦Î™Î”Î— Î£ÎœÎ‘Î¡Î‘Î“Î”Î‘" },
            { classId: "B2_GYM_2025_2026", regNo: "1159", name: "Î“Î¡Î™Î’Î‘ Î”Î•Î£Î ÎŸÎ™ÎÎ‘ - Î”Î—ÎœÎ—Î¤Î¡Î‘" },
            { classId: "B2_GYM_2025_2026", regNo: "1165", name: "ÎšÎ‘Î£Î‘Î¡Î™ Î‘Î¡Î¤Î•ÎœÎ™Î£" },
            { classId: "B2_GYM_2025_2026", regNo: "1173", name: "ÎœÎ‘Î¥Î¡ÎŸÎšÎ•Î¦Î‘Î›ÎŸÎ¥ - Î§Î‘Î›Î™ÎšÎ™Î‘ Î”Î•Î£Î ÎŸÎ™ÎÎ‘" },
            { classId: "B2_GYM_2025_2026", regNo: "1175", name: "ÎœÎ©Î¡Î‘ÎªÎ¤Î— Î‘Î“Î“Î•Î›Î™ÎšÎ—" },
            { classId: "B2_GYM_2025_2026", regNo: "1176", name: "ÎÎ™Î‘Î¦Î‘ ÎÎ•Î¦Î•Î›Î—" },
            { classId: "B2_GYM_2025_2026", regNo: "1177", name: "ÎÎ¤Î†ÎªÎšÎŸÎ¥ Î•Î›Î•ÎÎ—" },
            { classId: "B2_GYM_2025_2026", regNo: "1178", name: "Î Î‘Î›Î—ÎŸÎ“Î™Î‘ÎÎÎ—Î£ Î§Î¡Î—Î£Î¤ÎŸÎ£ Î‘Î“Î“Î•Î›ÎŸÎ£" },
            { classId: "B2_GYM_2025_2026", regNo: "1179", name: "Î Î‘ÎÎ™ÎÎŸÎ£ ÎÎ™ÎšÎŸÎ›Î‘ÎŸÎ£" },
            { classId: "B2_GYM_2025_2026", regNo: "1180", name: "Î Î‘Î Î‘Î”ÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ Î“Î•Î©Î¡Î“Î™ÎŸÎ£" },
            { classId: "B2_GYM_2025_2026", regNo: "1181", name: "Î Î‘Î Î‘Î›Î‘Î¥Î¡Î•ÎÎ¤Î™ÎŸÎ¥ Î¦ÎŸÎ™Î’Î—" },
            { classId: "B2_GYM_2025_2026", regNo: "1182", name: "Î Î‘Î ÎŸÎ¥Î¤Î£ÎŸÎ ÎŸÎ¥Î›ÎŸÎ¥ Î•Î›Î•ÎÎ—" },
            { classId: "B2_GYM_2025_2026", regNo: "1183", name: "Î ÎŸÎ›Î™Î¤Î— Î•Î™Î¡Î—ÎÎ—" },
            { classId: "B2_GYM_2025_2026", regNo: "1184", name: "Î ÎŸÎ¥Î¤ÎŸÎšÎ‘ Î•Î›Î•ÎÎ—" },
            { classId: "B2_GYM_2025_2026", regNo: "1185", name: "Î¡Î‘Î¦Î¤ÎŸÎ“Î™Î‘ÎÎÎ— Î‘Î“Î“Î•Î›Î™ÎšÎ— - ÎœÎ‘Î¡Î™Î‘" },
            { classId: "B2_GYM_2025_2026", regNo: "1188", name: "Î£ÎšÎ›Î‘Î’Î•ÎÎ™Î¤Î—Î£ Î”Î—ÎœÎ—Î¤Î¡Î™ÎŸÎ£ - Î”Î™ÎŸÎÎ¥Î£Î™ÎŸÎ£" },
            { classId: "B2_GYM_2025_2026", regNo: "1189", name: "Î£ÎšÎ›Î‘Î’Î•ÎÎ™Î¤Î—Î£ ÎÎ™ÎšÎŸÎ›Î‘ÎŸÎ£" },
            { classId: "B2_GYM_2025_2026", regNo: "1192", name: "Î£Î¤Î¡Î‘Î“Î‘Î›Î™ÎÎŸÎ¥ Î‘ÎÎÎ‘-ÎÎ•ÎšÎ¤Î‘Î¡Î™Î‘" },
            { classId: "B2_GYM_2025_2026", regNo: "1193", name: "Î£Î¤Î¡Î‘Î“Î‘Î›Î™ÎÎŸÎ¥ Î£Î¤Î‘ÎœÎ‘Î¤Î™ÎÎ‘" },
            { classId: "A1_LYK_2025_2026", regNo: "826", name: "Î‘ÎÎ”Î¡Î™ÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ ÎÎ™ÎšÎŸÎ›Î‘ÎŸÎ£" },
            { classId: "A1_LYK_2025_2026", regNo: "827", name: "Î‘Î¡Î“Î¥Î¡Î—Î£ Î•Î¥Î‘Î“Î“Î•Î›ÎŸÎ£" },
            { classId: "A1_LYK_2025_2026", regNo: "828", name: "Î’Î‘Î£Î™ÎŸÎ¥ ÎœÎ¥Î¡Î£Î™ÎÎ— Î‘ÎšÎ¡Î™Î’Î—" },
            { classId: "A1_LYK_2025_2026", regNo: "829", name: "Î’Î¡Î•Î¤Î¤ÎŸÎ£ Î’Î‘Î£Î™Î›Î•Î™ÎŸÎ£" },
            { classId: "A1_LYK_2025_2026", regNo: "830", name: "Î“Î•Î©Î¡Î“Î‘ÎšÎ— Î•Î™Î¡Î—ÎÎ—" },
            { classId: "A1_LYK_2025_2026", regNo: "831", name: "Î“Î•Î©Î¡Î“Î‘ÎšÎ—Î£ Î‘Î“Î“Î•Î›ÎŸÎ£" },
            { classId: "A1_LYK_2025_2026", regNo: "832", name: "Î”Î—ÎœÎ‘ÎšÎ—Î£ Î™Î©Î‘ÎÎÎ—Î£-ÎœÎ‘ÎÎ™ÎœÎŸÎ£" },
            { classId: "A1_LYK_2025_2026", regNo: "833", name: "Î”Î¡Î•Î¤Î¤Î‘ Î•Î¥Î¤Î¥Î§Î™Î‘ ÎšÎ¥Î¡Î™Î‘ÎšÎ—" },
            { classId: "A1_LYK_2025_2026", regNo: "834", name: "Î•Î¡Î“Î‘Î–Î‘ÎšÎ—Î£ ÎšÎ©ÎÎ£Î¤Î‘ÎÎ¤Î™ÎÎŸÎ£" },
            { classId: "A1_LYK_2025_2026", regNo: "835", name: "Î–Î‘Î’Î™Î¤Î£Î‘ÎÎŸÎ£ ÎÎ™ÎšÎ—Î¤Î‘Î£" },
            { classId: "A1_LYK_2025_2026", regNo: "836", name: "ÎšÎ‘Î¡Î‘ÎœÎ ÎŸÎªÎšÎ— Î•Î›Î™Î£Î‘Î’Î•Î¤" },
            { classId: "A1_LYK_2025_2026", regNo: "837", name: "ÎšÎ‘Î£ÎŸÎ¥Î¡Î‘ Î”Î—ÎœÎ—Î¤Î¡Î‘-Î’Î‘Î£Î™Î›Î™ÎšÎ—" },
            { classId: "A1_LYK_2025_2026", regNo: "838", name: "ÎšÎ‘Î¤Î‘Î“Î— ÎœÎ‘Î¡Î™ÎÎ‘" },
            { classId: "A1_LYK_2025_2026", regNo: "839", name: "ÎšÎ‘Î¤Î©Î ÎŸÎ”Î—Î£ Î”Î™ÎŸÎÎ¥Î£Î—Î£" },
            { classId: "A1_LYK_2025_2026", regNo: "840", name: "ÎšÎ‘Î¤Î©Î ÎŸÎ”Î—Î£ Î˜Î•ÎŸÎ”Î©Î¡ÎŸÎ£" },
            { classId: "A1_LYK_2025_2026", regNo: "841", name: "ÎšÎŸÎ“ÎšÎ‘ Î”Î—ÎœÎ—Î¤Î¡Î‘" },
            { classId: "A1_LYK_2025_2026", regNo: "844", name: "ÎšÎ©Î£Î¤Î‘ÎšÎ—Î£ ÎœÎ‘Î¡ÎšÎŸÎ£-Î§Î¡Î—Î£Î¤ÎŸÎ£" },
            { classId: "A1_LYK_2025_2026", regNo: "845", name: "ÎœÎ‘ÎšÎ¡Î¥Î“Î•Î©Î¡Î“ÎŸÎ¥-ÎœÎ Î™Î¡ÎœÎ Î‘ ÎœÎ‘Î¡Î™Î‘-Î›ÎŸÎ¥ÎšÎ™Î‘" },
            { classId: "A1_LYK_2025_2026", regNo: "846", name: "ÎœÎ‘Î›Î¦Î‘ Î“Î•Î©Î¡Î“Î™Î‘-ÎœÎ‘Î¡Î™Î‘" },
            { classId: "A1_LYK_2025_2026", regNo: "852", name: "Î¡ÎŸÎšÎŸÎ¥ Î”Î•Î£Î ÎŸÎ™ÎÎ‘" },
            { classId: "A1_LYK_2025_2026", regNo: "861", name: "Î¤Î£Î‘ÎšÎÎ‘ÎšÎ— Î•Î’Î•Î›Î™ÎÎ‘-Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—" },
            { classId: "A2_LYK_2025_2026", regNo: "842", name: "ÎšÎŸÎ¥Î¤Î£ÎŸÎ›Î™Î‘ÎšÎŸÎ¥ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡Î‘ - Î”Î•Î£Î ÎŸÎ™ÎÎ‘" },
            { classId: "A2_LYK_2025_2026", regNo: "843", name: "ÎšÎ¡Î—Î¤Î™ÎšÎŸÎ£ Î£Î Î¥Î¡Î™Î”Î©Î" },
            { classId: "A2_LYK_2025_2026", regNo: "847", name: "ÎœÎ™Î¤Î™Î›Î— Î‘ÎÎ‘Î£Î¤Î‘Î£Î™Î‘" },
            { classId: "A2_LYK_2025_2026", regNo: "848", name: "ÎœÎ Î‘Î›Î‘Îª ÎÎ™ÎšÎŸÎ›Î‘ÎŸÎ£-Î˜Î•ÎŸÎ”Î©Î¡ÎŸÎ£" },
			{ classId: "A2_LYK_2025_2026", regNo: "000", name: "Î Î‘Î Î‘Î“Î™Î‘ÎÎÎ™Î”Î—Î£ Î’Î‘Î£Î™Î›Î•Î™ÎŸÎ£" },
            { classId: "A2_LYK_2025_2026", regNo: "849", name: "Î Î‘ÎÎ™ÎÎŸÎ¥ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡Î‘" },
            { classId: "A2_LYK_2025_2026", regNo: "850", name: "Î Î‘Î Î‘Î”ÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ Î•Î¥Î£Î¤Î‘Î˜Î™ÎŸÎ£" },
            { classId: "A2_LYK_2025_2026", regNo: "851", name: "Î Î‘Î Î‘Î”ÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ Î™Î©Î‘ÎÎÎ—Î£" },
            { classId: "A2_LYK_2025_2026", regNo: "853", name: "Î¡ÎŸÎœÎ ÎŸÎ¤Î— Î‘Î¦Î¡ÎŸÎ”Î™Î¤Î—" },
            { classId: "A2_LYK_2025_2026", regNo: "854", name: "Î¡ÎŸÎœÎ ÎŸÎ¤Î— ÎšÎ©ÎÎ£Î¤Î‘ÎÎ¤Î™ÎÎ‘" },
            { classId: "A2_LYK_2025_2026", regNo: "855", name: "Î£Î“ÎŸÎ¥Î¡ÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ Î£Î Î¥Î¡Î™Î”Î©Î" },
            { classId: "A2_LYK_2025_2026", regNo: "856", name: "Î£Î“ÎŸÎ¥Î¡ÎŸÎ ÎŸÎ¥Î›ÎŸÎ¥ Î–Î©Î—" },
            { classId: "A2_LYK_2025_2026", regNo: "857", name: "Î£Î™Î”Î•Î¡Î‘Î£ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡ÎŸÎ£" },
            { classId: "A2_LYK_2025_2026", regNo: "858", name: "Î£ÎŸÎ¥ÎÎ”Î™Î‘Î£ Î”Î—ÎœÎ—Î¤Î¡Î™ÎŸÎ£" },
            { classId: "A2_LYK_2025_2026", regNo: "859", name: "Î£Î¤Î¡Î‘Î¤ÎŸÎ£ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡ÎŸÎ£-ÎœÎ™Î§Î‘Î—Î›" },
            { classId: "A2_LYK_2025_2026", regNo: "860", name: "Î¤Î‘ÎÎ¤AÎ¡ÎŸÎ£ Î™Î‘Î£ÎŸÎÎ‘Î£" },
            { classId: "A2_LYK_2025_2026", regNo: "862", name: "Î¤Î£Î‘Î¡ÎÎ‘ Î”Î—ÎœÎ—Î¤Î¡Î‘" },
            { classId: "A2_LYK_2025_2026", regNo: "863", name: "Î¦Î•Î¤Î£Î— ÎÎ•Î¦Î•Î›Î—" },
            { classId: "A2_LYK_2025_2026", regNo: "864", name: "Î¦Î¡Î•ÎœÎ•ÎÎ¤Î™Î¤Î—Î£ Î‘ÎÎ‘Î£Î¤Î‘Î£Î™ÎŸÎ£ Î Î‘Î¥Î›ÎŸÎ£" },
            { classId: "A2_LYK_2025_2026", regNo: "865", name: "Î¦Î©Î¤Î•Î™ÎÎŸÎ¥ Î§Î‘Î¡Î‘" },
            { classId: "A2_LYK_2025_2026", regNo: "866", name: "Î§ÎŸÎ¡Î¤Î—Î£ ÎœÎ‘Î¡Î™ÎŸÎ£" },
            { classId: "A2_LYK_2025_2026", regNo: "867", name: "Î§Î¡Î™Î£Î¤ÎŸÎ¦Î™Î”Î— Î“Î•Î©Î¡Î“Î™Î‘" }
        ];

        const subjects = ["ÎŸÎ”Î¥Î£Î£Î•Î™Î‘", "Î‘Î¡Î§Î‘Î™Î‘", "Î™Î£Î¤ÎŸÎ¡Î™Î‘", "Î“Î›Î©Î£Î£Î‘"];
        const categories = ["Î”Î™Î‘Î“Î©ÎÎ™Î£ÎœÎ‘", "Î¤Î•Î£Î¤", "Î Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ‘", "Î•Î¡Î“Î‘Î£Î™Î‘", "Î¤Î•Î¤Î¡Î‘Î”Î™ÎŸ", "Î Î‘Î¡Î‘Î˜Î•ÎœÎ‘", "Î Î‘Î¡Î‘Î“Î¡Î‘Î¦ÎŸÎ£", "Î Î•Î¡Î™Î›Î—Î¨Î—", "Î•ÎšÎ˜Î•Î£Î—", "Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£"];
        const periods = [
            { id: '1', name: 'Î‘Î„ Î¤ÏÎ¯Î¼Î·Î½Î¿', start: '2025-09-01', end: '2025-12-31' },
            { id: '2', name: 'Î’Î„ Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿', start: '2026-01-01', end: '2026-05-31' }
        ];
        
        const commentPhrases = [
            { id: 1, category: "Î˜ÎµÏ„Î¹ÎºÏŒ", text: "Î Î¿Î»Ï ÎºÎ±Î»Î® Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± ÏƒÎ®Î¼ÎµÏÎ±." },
            { id: 2, category: "Î˜ÎµÏ„Î¹ÎºÏŒ", text: "Î£Î±Ï†Î®Ï‚ Î´Î¿Î¼Î® ÎºÎ±Î¹ ÏƒÏ‰ÏƒÏ„Î® Ï„ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ·." },
            { id: 3, category: "Î’ÎµÎ»Ï„Î¯Ï‰ÏƒÎ·", text: "Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ· Ï€ÏÎ¿ÏƒÎ¿Ï‡Î® ÏƒÏ„Î·Î½ Î±Î½Î¬Î»Ï…ÏƒÎ·." },
            { id: 4, category: "Î’ÎµÎ»Ï„Î¯Ï‰ÏƒÎ·", text: "ÎÎ± Î²ÎµÎ»Ï„Î¹ÏÏƒÎµÎ¹ Ï„Î·Î½ Î¿ÏÎ¸Î¿Î³ÏÎ±Ï†Î¯Î±/ÏƒÎ·Î¼ÎµÎ¯Î± ÏƒÏ„Î¯Î¾Î·Ï‚." },
            { id: 5, category: "Î£Ï…Î¼Ï€ÎµÏÎ¹Ï†Î¿ÏÎ¬", text: "Î£Ï…Î½ÎµÏÎ³Î¬ÏƒÎ¹Î¼Î¿Ï‚/Î· ÏƒÏ„Î·Î½ Ï„Î¬Î¾Î·." },
            { id: 6, category: "Î£Ï…Î¼Ï€ÎµÏÎ¹Ï†Î¿ÏÎ¬", text: "Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ ÎºÎ±Î»ÏÏ„ÎµÏÎ· ÏƒÏ…Î³ÎºÎ­Î½Ï„ÏÏ‰ÏƒÎ· ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î¬ÏÎºÎµÎ¹Î± Ï„Î¿Ï… Î¼Î±Î¸Î®Î¼Î±Ï„Î¿Ï‚." }
        ];
        // -----------------------------
        // Gradebook ("database") cache
        // - Reports MUST read from the gradebook.
        // - History may hide records without deleting them from the gradebook.
        // -----------------------------
        const GRADEBOOK_KEY = 'bizou_gradebook_v1';
        const LEGACY_GRADEBOOK_KEY = 'bizou_grades';
        // const HISTORY_HIDDEN_KEY removed (duplicate);

        function loadGradebook_() {
            let raw = localStorage.getItem(GRADEBOOK_KEY);
            if (!raw) raw = localStorage.getItem(LEGACY_GRADEBOOK_KEY);
            let arr;
            try { arr = JSON.parse(raw || '[]'); } catch(e) { arr = []; }
            arr = Array.isArray(arr) ? arr : [];
            // Normalize (older records may not have the new fields)
            arr = arr.map(g => ({...g, synced: (g && typeof g.synced === 'boolean') ? g.synced : false}));
            // Migrate forward
            try { localStorage.setItem(GRADEBOOK_KEY, JSON.stringify(arr)); } catch(e) {}
            return arr;
        }

        function saveGradebook_() {
            try { localStorage.setItem(GRADEBOOK_KEY, JSON.stringify(grades)); } catch(e) {}
        }

        // -----------------------------
        // History 'delete' is actually HIDE (does NOT affect gradebook/reports)
        // -----------------------------
        const HISTORY_HIDDEN_KEY = 'bizou_history_hidden_ids_v1';

        function getHiddenHistoryIds_() {
            try {
                const raw = localStorage.getItem(HISTORY_HIDDEN_KEY) || '[]';
                const arr = JSON.parse(raw);
                return new Set((Array.isArray(arr) ? arr : []).map(String));
            } catch(e) {
                return new Set();
            }
        }

        function setHiddenHistoryIds_(setObj) {
            try { localStorage.setItem(HISTORY_HIDDEN_KEY, JSON.stringify(Array.from(setObj))); } catch(e) {}
        }

        function hideHistoryGrade(id) {
            const hid = getHiddenHistoryIds_();
            hid.add(String(id));
            setHiddenHistoryIds_(hid);
            renderHistory();
        }

        function unhideAllHistory() {
            try { localStorage.removeItem(HISTORY_HIDDEN_KEY); } catch(e) {}
            renderHistory();
        }



        function getHiddenHistoryIds_() {
            try {
                const raw = localStorage.getItem(HISTORY_HIDDEN_KEY) || '[]';
                const arr = JSON.parse(raw);
                return new Set(Array.isArray(arr) ? arr.map(String) : []);
            } catch(e) {
                return new Set();
            }
        }

        function setHiddenHistoryIds_(set) {
            try { localStorage.setItem(HISTORY_HIDDEN_KEY, JSON.stringify(Array.from(set))); } catch(e) {}
        }

        // Gradebook in memory
        let grades = loadGradebook_();
        // ============== INITIALIZATION ==============
        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('grade-date').value = today;
            
            initializeDropdowns();
            initializePhraseChips();
            updateStats();
            renderRecentGrades();
        });

        function initializeDropdowns() {
            // Classes
            const classSelect = document.getElementById('class-select');
            const historyClassFilter = document.getElementById('history-class-filter');
            const cardClassSelect = document.getElementById('card-class');
            
            classes.forEach(c => {
                classSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                historyClassFilter.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                cardClassSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });

            // Subjects
            const subjectSelect = document.getElementById('subject-select');
            subjects.forEach(s => {
                subjectSelect.innerHTML += `<option value="${s}">${s}</option>`;
            });

            // Categories
            const categorySelect = document.getElementById('category-select');
            categories.forEach(c => {
                categorySelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
        }

        function initializePhraseChips() {
            const container = document.getElementById('phrase-chips');
            commentPhrases.forEach(phrase => {
                const chip = document.createElement('button');
                chip.className = 'phrase-chip';
                chip.textContent = phrase.text.substring(0, 30) + (phrase.text.length > 30 ? '...' : '');
                chip.title = phrase.text;
                chip.onclick = () => addPhrase(phrase.text);
                container.appendChild(chip);
            });
        }

        // ============== STUDENT BANNER ==============
        function updateStudentBanner() {
            const studentSelect = document.getElementById('student-select');
            const classSelect = document.getElementById('class-select');
            const banner = document.getElementById('student-banner');
            const bannerName = document.getElementById('banner-student-name');
            const bannerClass = document.getElementById('banner-class-name');

            if (studentSelect.value) {
                const student = students.find(s => s.regNo === studentSelect.value && s.classId === classSelect.value);
                const className = classes.find(c => c.id === classSelect.value)?.name;
                
                bannerName.textContent = student?.name || '-';
                bannerClass.textContent = className || '-';
                banner.classList.add('visible');
            } else {
                banner.classList.remove('visible');
            }
            
            // Update live stats when student changes
            updateLiveStats();
        }

        // ============== LIVE STATS ==============
        function updateLiveStats() {
            const classId = document.getElementById('class-select').value;
            const studentRegNo = document.getElementById('student-select').value;
            const subject = document.getElementById('subject-select').value;
            const category = document.getElementById('category-select').value;

            const classAvgEl = document.getElementById('class-avg');
            const studentAvgEl = document.getElementById('student-avg');

            // Reset if not enough selections
            if (!classId || !subject || !category) {
                classAvgEl.textContent = '-';
                studentAvgEl.textContent = '-';
                return;
            }

            // Calculate class average for this subject + category
            const classStudentIds = students.filter(s => s.classId === classId).map(s => s.regNo);
            const classGrades = grades.filter(g => 
                g.classId === classId && 
                g.subject === subject && 
                g.category === category
            );

            if (classGrades.length > 0) {
                // Normalize scores to 20 scale for fair comparison
                const normalizedScores = classGrades.map(g => {
                    return g.scale === 100 ? (g.score / 5) : g.score;
                });
                const classAvg = normalizedScores.reduce((sum, s) => sum + s, 0) / normalizedScores.length;
                classAvgEl.textContent = classAvg.toFixed(1);
            } else {
                classAvgEl.textContent = '-';
            }

            // Calculate student average for this subject + category
            if (studentRegNo) {
                const studentGrades = grades.filter(g => 
                    g.studentRegNo === studentRegNo && 
                    g.classId === classId &&
                    g.subject === subject && 
                    g.category === category
                );

                if (studentGrades.length > 0) {
                    // Normalize scores to 20 scale
                    const normalizedScores = studentGrades.map(g => {
                        return g.scale === 100 ? (g.score / 5) : g.score;
                    });
                    const studentAvg = normalizedScores.reduce((sum, s) => sum + s, 0) / normalizedScores.length;
                    studentAvgEl.textContent = studentAvg.toFixed(1);
                } else {
                    studentAvgEl.textContent = '-';
                }
            } else {
                studentAvgEl.textContent = '-';
            }
        }

        // ============== DROPDOWN HANDLERS ==============
        function updateStudents() {
            const classId = document.getElementById('class-select').value;
            const studentSelect = document.getElementById('student-select');
            const scaleSelection = document.getElementById('scale-selection');
            
            studentSelect.innerHTML = '<option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î±Î¸Î·Ï„Î®...</option>';
            
            // Reset banner when class changes
            document.getElementById('student-banner').classList.remove('visible');
            
            // Check if it's Lyceum (LYK) - show scale selection
            const isLyceum = classId.includes('LYK');
            scaleSelection.style.display = isLyceum ? 'block' : 'none';
            
            // Reset to scale 20 when changing class
            if (!isLyceum) {
                setScale(20);
            }
            
            if (classId) {
                studentSelect.disabled = false;
                const classStudents = students
                    .filter(s => s.classId === classId)
                    .sort((a, b) => a.name.localeCompare(b.name, 'el'));
                
                classStudents.forEach(s => {
                    studentSelect.innerHTML += `<option value="${s.regNo}">${s.name}</option>`;
                });
            } else {
                studentSelect.disabled = true;
                studentSelect.innerHTML = '<option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÏÏ„Î± Ï„Î¬Î¾Î·...</option>';
            }
            
            // Update live stats when class changes
            updateLiveStats();
        }

        // ============== SCORE HANDLERS ==============
        let currentScale = 20; // Default scale
        let cardScale = 20; // Scale for student card final grades

        function setScale(scale) {
            currentScale = scale;
            
            // Update buttons
            document.getElementById('scale-20-btn').classList.toggle('active', scale === 20);
            document.getElementById('scale-100-btn').classList.toggle('active', scale === 100);
            
            // Show/hide score sections
            document.getElementById('score-section-20').style.display = scale === 20 ? 'block' : 'none';
            document.getElementById('score-section-100').style.display = scale === 100 ? 'block' : 'none';
        }

        function setCardScale(scale) {
            cardScale = scale;
            
            // Update buttons
            const btn20 = document.getElementById('card-scale-20-btn');
            const btn100 = document.getElementById('card-scale-100-btn');
            if (btn20) btn20.classList.toggle('active', scale === 20);
            if (btn100) btn100.classList.toggle('active', scale === 100);
            
            // Update all final grade inputs in the card
            document.querySelectorAll('.card-final-input').forEach(input => {
                input.max = scale;
                input.step = scale === 100 ? '1' : '0.5';
                // Update placeholder to show max
                input.placeholder = scale === 100 ? '0-100' : 'â€”';
            });
            
            showToast(`ÎšÎ»Î¯Î¼Î±ÎºÎ±: 0-${scale}`);
        }

        function updateScore20(value) {
            document.getElementById('score-display-20').textContent = value;
            document.querySelectorAll('#score-section-20 .quick-score-btn').forEach(btn => {
                btn.classList.toggle('active', parseFloat(btn.textContent) === parseFloat(value));
            });
        }

        function setScore20(value) {
            document.getElementById('score-slider-20').value = value;
            updateScore20(value);
        }

        function updateScore100(value) {
            document.getElementById('score-display-100').textContent = value;
            document.querySelectorAll('#score-section-100 .quick-score-btn').forEach(btn => {
                btn.classList.toggle('active', parseFloat(btn.textContent) === parseFloat(value));
            });
        }

        function setScore100(value) {
            document.getElementById('score-slider-100').value = value;
            updateScore100(value);
        }

        // Legacy functions for compatibility
        function updateScore(value) {
            updateScore20(value);
        }

        function setScore(value) {
            setScore20(value);
        }

        // ============== NOTES HANDLERS ==============
        function addPhrase(text) {
            const textarea = document.getElementById('notes-input');
            const currentText = textarea.value;
            textarea.value = currentText ? currentText + ' ' + text : text;
        }

        // ============== SAVE GRADE ==============
        // ID Strategy (important):
        // - For "final" categories (Î‘Î„ Î¤ÏÎ¯Î¼Î·Î½Î¿ / Î’Î„ Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿ / Î¤ÎµÎ»Î¹ÎºÏŒÏ‚ ÎˆÏ„Î¿Ï…Ï‚), we must
        //   produce a deterministic ID so the backend can UPSERT instead of appending.
        //   Otherwise, every manual edit creates duplicates (same logical grade, new row).
        // - For non-final assessments (e.g., Î´Î¹Î±Î³Ï‰Î½Î¯ÏƒÎ¼Î±Ï„Î±), we keep unique IDs per entry.

        function isFinalCategory(category) {
          const c = String(category || '').trim();
          return (
            c === 'Î‘Î„ Î¤ÏÎ¯Î¼Î·Î½Î¿' ||
            c === 'AÎ„ Î¤ÏÎ¯Î¼Î·Î½Î¿' ||
            c === "Î‘' Î¤ÏÎ¯Î¼Î·Î½Î¿" ||
            c === "A' Î¤ÏÎ¯Î¼Î·Î½Î¿" ||
            c === 'Î’Î„ Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿' ||
            c === 'BÎ„ Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿' ||
            c === "Î’' Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿" ||
            c === "B' Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿" ||
            c === 'Î¤ÎµÎ»Î¹ÎºÏŒÏ‚ ÎˆÏ„Î¿Ï…Ï‚' ||
            c === 'Î¤ÎµÎ»Î¹ÎºÏŒÏ‚ Î•Ï„Î¿Ï…Ï‚' ||
            c === 'Î¤ÎµÎ»Î¹ÎºÏŒÏ‚'
          );
        }

        function categoryToCode(category) {
          const c = String(category || '').trim();
          if (c.includes('Î¤ÏÎ¯Î¼Î·Î½Î¿')) return 'TRI';
          if (c.includes('Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿') || c.includes('Î¤ÎµÏ„ÏÎ±Î¼Î·Î½Î¿')) return 'TET';
          if (c.includes('ÎˆÏ„Î¿Ï…Ï‚') || c.includes('Î•Ï„Î¿Ï…Ï‚') || c === 'Î¤ÎµÎ»Î¹ÎºÏŒÏ‚') return 'YEAR';
          // Fallback â€“ keep something stable
          return c.toUpperCase().replace(/\s+/g, '_').slice(0, 12) || 'UNK';
        }

        function subjectToCode(subjectName) {
          const idx = subjects.indexOf(subjectName);
          // Matches your existing FIN_..._S0, S1, S2... pattern used in bulk finals.
          return idx >= 0 ? `S${idx}` : 'SUNK';
        }

        // Stable ASCII ID for non-final assessments.
        // We use a base64url encoding of the natural key so:
        // - edits overwrite (UPSERT) instead of creating duplicates
        // - IDs remain safe for URLs / Sheets
        function base64UrlEncode(str) {
          const b64 = btoa(unescape(encodeURIComponent(str)));
          return b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
        }

        
        function makeAssessmentId({ classId, schoolYear, studentRegistryNo, subjectName, category, dateISO }) {
          const naturalKey = [classId, schoolYear, studentRegistryNo, subjectName, category, dateISO].join('|');
          return `GR_${base64UrlEncode(naturalKey)}`;
        }

        function makeGradeId({ classId, schoolYear, studentRegistryNo, subjectName, category, dateISO }) {
          if (isFinalCategory(category)) {
            // Deterministic (one row per student/subject/final-category)
            return `FIN_${classId}_${schoolYear}_${studentRegistryNo}_${subjectToCode(subjectName)}_${categoryToCode(category)}`;
          }
          // Deterministic per natural key (one row per student/subject/category/date)
          return makeAssessmentId({ classId, schoolYear, studentRegistryNo, subjectName, category, dateISO });
        }

        function saveGrade() {
            const classId = document.getElementById('class-select').value;
            const schoolYear = SCHOOL_YEAR;
            const studentRegNo = document.getElementById('student-select').value;
            const subject = document.getElementById('subject-select').value;
            const category = document.getElementById('category-select').value;
            const notes = document.getElementById('notes-input').value;
            const selectedDate = document.getElementById('grade-date').value;

            // Get score based on current scale
            let score;
            let scale;
            if (currentScale === 100) {
                score = parseFloat(document.getElementById('score-slider-100').value);
                scale = 100;
            } else {
                score = parseFloat(document.getElementById('score-slider-20').value);
                scale = 20;
            }

            // Validation
            if (!classId || !studentRegNo || !subject || !category) {
                showToast('Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î±');
                return;
            }

            if (!selectedDate) {
                showToast('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±');
                return;
            }

            const student = students.find(s => s.regNo === studentRegNo && s.classId === classId);
            const className = classes.find(c => c.id === classId)?.name;

            // ID:
            // - Finals => deterministic FIN_<classId>_<regNo>_<Sx>_<TRI|TET|YEAR>
            // - Other assessments => unique GR_<timestamp>_<rand>
            // ID policy:
            // - Finals: readable deterministic FIN_... ID
            // - Assessments: deterministic GR_... ID based on the natural key
            //   (class/year/student/subject/category/date) so edits don't create new rows.
            const uniqueId = isFinalCategory(category)
                ? makeGradeId({
                    classId,
                    SCHOOL_YEAR,
                    studentRegistryNo: studentRegNo,
                    subjectName: subject,
                    category,
                  })
                : makeAssessmentId({
                    classId,
                    SCHOOL_YEAR,
                    studentRegistryNo: studentRegNo,
                    subjectName: subject,
                    category,
                    dateISO: selectedDate,
                  });
            
            // Current datetime for when the grade is saved
            const savedAt = new Date().toISOString();

            const grade = {
                id: uniqueId,
                classId,
                className,
                studentRegNo,
                studentName: student?.name,
                subject,
                category,
                score,
                scale, // Store which scale was used
                notes,
                date: selectedDate, // The grade date (selected by user)
                savedAt: savedAt,   // When it was actually saved (with time)
                synced: false
            };

            grades.unshift(grade);
            localStorage.setItem(GRADEBOOK_KEY, JSON.stringify(grades));

            // Shadow sync to Google Sheets (non-blocking)
            // Always UPSERT: the server is responsible for dedupe and updates.
            const syncAction = 'upsert';
            try {
                syncToGoogleSheets(grade, syncAction);
            } catch (e) {
                console.warn('Google sync call failed:', e);
            }

            // Reset form (keep class, subject, category for quick entry)
            document.getElementById('student-select').value = '';
            document.getElementById('notes-input').value = '';
            document.getElementById('student-banner').classList.remove('visible');
            setScore20(10);
            setScore100(50);

            updateStats();
            updateLiveStats();
            renderRecentGrades();
            showToast('âœ“ ÎŸ Î²Î±Î¸Î¼ÏŒÏ‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ');
        }

        // ============== STATS (Legacy - kept for compatibility) ==============
        function updateStats() {
            // Now handled by updateLiveStats()
        }

        // ============== RENDER GRADES ==============
        function renderRecentGrades() {
            const container = document.getElementById('recent-grades');
            const recentGrades = grades.slice(0, 5);

            if (recentGrades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <div class="empty-text">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î®ÏƒÎµÎ¹Ï‚ Î±ÎºÏŒÎ¼Î±</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = recentGrades.map(g => {
                const scaleLabel = g.scale === 100 ? '/100' : '/20';
                return `
                <div class="grade-item">
                    <div class="grade-score-badge">${g.score}<span style="font-size:10px;opacity:0.8">${scaleLabel}</span></div>
                    <div class="grade-details">
                        <div class="grade-student">${g.studentName}</div>
                        <div class="grade-meta">${g.subject} â€¢ ${g.category} â€¢ ${formatDate(g.date)}</div>
                    </div>
                </div>
            `}).join('');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) return 'Î£Î®Î¼ÎµÏÎ±';
            if (date.toDateString() === yesterday.toDateString()) return 'Î§Î¸ÎµÏ‚';
            
            return date.toLocaleDateString('el-GR', { day: 'numeric', month: 'short' });
        }

        // ============== DELETE & EDIT GRADE ==============
        function deleteGrade(id) {
            if (confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î±Ï…Ï„Î® Ï„Î· Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±;')) {
                grades = grades.filter(g => g.id !== id);
                localStorage.setItem(GRADEBOOK_KEY, JSON.stringify(grades));
                renderHistory();
                renderRecentGrades();
                updateLiveStats();
                showToast('âœ“ Î— Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ');
                // Shadow sync delete to Google Sheets (best-effort)
                try { syncToGoogleSheets({ id: id }, 'delete'); } catch (e) { console.warn(e); }
            }
        }

        function editGrade(id) {
            const grade = grades.find(g => g.id === id);
            if (!grade) return;

            // Open edit modal
            const modal = document.getElementById('report-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            modalTitle.textContent = 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î’Î±Î¸Î¼Î¿Ï';
            modalBody.innerHTML = `
                <div class="edit-grade-info" style="background:#f8f5fc;padding:12px;border-radius:8px;margin-bottom:15px;">
                    <strong>${grade.studentName}</strong><br>
                    <span style="color:#666;font-size:12px;">${grade.className} â€¢ ${grade.subject} â€¢ ${grade.category}</span>
                </div>
                <div class="select-group">
                    <label class="select-label">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
                    <input type="date" class="custom-select date-input" id="edit-date" value="${grade.date.split('T')[0]}">
                </div>
                <div class="select-group">
                    <label class="select-label">Î’Î±Î¸Î¼ÏŒÏ‚ (${grade.scale === 100 ? '0-100' : '0-20'})</label>
                    <input type="number" class="custom-select" id="edit-score" value="${grade.score}" 
                           min="0" max="${grade.scale}" step="0.5" style="text-align:center;font-size:18px;font-weight:bold;">
                </div>
                <div class="select-group">
                    <label class="select-label">Î£Ï‡ÏŒÎ»Î¹Î±</label>
                    <textarea class="notes-input" id="edit-notes" rows="3">${grade.notes || ''}</textarea>
                </div>
                <button class="submit-btn" onclick="saveEditedGrade('${id}')">
                    <span>ğŸ’¾</span>
                    <span>Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î‘Î»Î»Î±Î³ÏÎ½</span>
                </button>
            `;

            modal.classList.add('active');
        }

        function saveEditedGrade(id) {
            const newDate = document.getElementById('edit-date').value;
            const newScore = parseFloat(document.getElementById('edit-score').value);
            const newNotes = document.getElementById('edit-notes').value;

            if (!newDate || isNaN(newScore)) {
                showToast('Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î± Ï€ÎµÎ´Î¯Î±');
                return;
            }

            const gradeIndex = grades.findIndex(g => g.id === id);
            if (gradeIndex === -1) return;

            grades[gradeIndex].date = new Date(newDate + 'T12:00:00').toISOString();
            grades[gradeIndex].score = newScore;
            grades[gradeIndex].notes = newNotes;

            localStorage.setItem(GRADEBOOK_KEY, JSON.stringify(grades));
            closeModal();
            renderHistory();
            renderRecentGrades();
            updateLiveStats();
            showToast('âœ“ ÎŸ Î²Î±Î¸Î¼ÏŒÏ‚ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ');
            // Shadow sync update to Google Sheets (does not affect UI/reports)
            // Use UPSERT so deterministic IDs (finals) are overwritten safely.
            try { syncToGoogleSheets(grades[gradeIndex], 'upsert'); } catch (e) { console.warn(e); }
        }

        // ============== NAVIGATION ==============
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            const viewElement = document.getElementById(`${viewName}-view`);
            if (viewElement) {
                viewElement.classList.add('active');
            }

            // Find and activate the correct nav button
            const navIndex = { 'grading': 0, 'student-card': 1, 'history': 2, 'reports': 3 };
            const navItems = document.querySelectorAll('.nav-item');
            if (navItems[navIndex[viewName]]) {
                navItems[navIndex[viewName]].classList.add('active');
            }

            // Refresh data when switching views
            if (viewName === 'history') {
                renderHistory();
            } else if (viewName === 'student-card') {
                // Reset student card if no student selected
                const cardStudent = document.getElementById('card-student');
                if (cardStudent && cardStudent.value) {
                    loadStudentCard();
                }
            } else if (viewName === 'grading') {
                renderRecentGrades();
                updateLiveStats();
            }
        }

        
        // --- Reports must always use the latest persisted grades (not the currently rendered History list) ---
        function getGradesForReports() {
            let g = [];
            try { g = JSON.parse(localStorage.getItem(GRADEBOOK_KEY) || '[]'); } catch (e) { g = []; }
            if (!Array.isArray(g)) g = [];
            // Prefer the larger set (guards against stale in-memory state on mobile)
            try {
                if (Array.isArray(window.grades) && window.grades.length > g.length) g = window.grades;
            } catch (e) {}
            return g;
        }

function showReports() {
            showView('reports');
        }

        // ============== HISTORY ==============
        function renderHistory() {            const container = document.getElementById('history-list');
            const filter = document.getElementById('history-class-filter').value;
            const hidden = getHiddenHistoryIds_();

            let filteredGrades = filter
                ? grades.filter(g => g.classId === filter && !hidden.has(String(g.id)))
                : grades.filter(g => !hidden.has(String(g.id)));


            if (filteredGrades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“‹</div>
                        <div class="empty-text">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î®ÏƒÎµÎ¹Ï‚</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredGrades.map(g => {
                const scaleLabel = g.scale === 100 ? '/100' : '/20';
                return `
                <div class="grade-item" data-id="${g.id}">
                    <div class="grade-score-badge">${g.score}<span style="font-size:10px;opacity:0.8">${scaleLabel}</span></div>
                    <div class="grade-details">
                        <div class="grade-student">${g.studentName}</div>
                        <div class="grade-meta">${g.className}<br>${g.subject} â€¢ ${g.category} â€¢ ${formatDate(g.date)}</div>
                        ${g.notes ? `<div class="grade-meta" style="margin-top:4px;font-style:italic;">"${g.notes.substring(0,50)}${g.notes.length > 50 ? '...' : ''}"</div>` : ''}
                    </div>
                    <div class="grade-actions">
                        <button class="action-btn edit-btn" onclick="editGrade('${g.id}')" title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±">âœï¸</button>
                        <button class="action-btn delete-btn" onclick="hideHistoryGrade('${g.id}')" title="Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ· Î±Ï€ÏŒ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `}).join('');
        }

        function filterHistory() {
            renderHistory();
        }

        // ============== STUDENT CARD ==============
        let finalGrades = JSON.parse(localStorage.getItem('bizou_final_grades') || '{}');
        const FINAL_GRADES_KEY = 'bizou_final_grades';
        
        function loadFinalGrades_() {
            try {
                return JSON.parse(localStorage.getItem(FINAL_GRADES_KEY) || '{}');
            } catch(e) {
                return {};
            }
        }
        
        // Helper: Î Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¿Î½ Ï„ÎµÎ»Î¹ÎºÏŒ Î²Î±Î¸Î¼ÏŒ Î³Î¹Î± Î­Î½Î± Î¼Î¬Î¸Î·Î¼Î±
        function getFinalGrade(classId, studentRegNo, subject, period) {
            const finalKey = `${classId}_${studentRegNo}`;
            const fg = finalGrades[finalKey] || {};
            const key = `${subject}_${period}`;
            return fg[key] || '';
        }

        function updateCardStudents() {
            const classId = document.getElementById('card-class').value;
            const studentSelect = document.getElementById('card-student');
            
            studentSelect.innerHTML = '<option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î±Î¸Î·Ï„Î®...</option>';
            document.getElementById('student-card-content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ‘¤</div>
                    <div class="empty-text">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î±Î¸Î·Ï„Î® Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ ÎºÎ±ÏÏ„Î­Î»Î± Ï„Î¿Ï…</div>
                </div>
            `;
            
            if (classId) {
                studentSelect.disabled = false;
                const classStudents = students
                    .filter(s => s.classId === classId)
                    .sort((a, b) => a.name.localeCompare(b.name, 'el'));
                
                classStudents.forEach(s => {
                    studentSelect.innerHTML += `<option value="${s.regNo}">${s.name}</option>`;
                });
            } else {
                studentSelect.disabled = true;
            }
        }

        function loadStudentCard() {
            const classId = document.getElementById('card-class').value;
            const studentRegNo = document.getElementById('card-student').value;
            const container = document.getElementById('student-card-content');

            if (!classId || !studentRegNo) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘¤</div>
                        <div class="empty-text">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î±Î¸Î·Ï„Î® Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ ÎºÎ±ÏÏ„Î­Î»Î± Ï„Î¿Ï…</div>
                    </div>
                `;
                return;
            }

            const student = students.find(s => s.regNo === studentRegNo && s.classId === classId);
            const className = classes.find(c => c.id === classId)?.name || '';
            const studentGrades = grades.filter(g => g.studentRegNo === studentRegNo && g.classId === classId);

            // Check if class is Lyceum for scale toggle
            const isLyceum = className.toUpperCase().includes('Î›Î¥ÎšÎ•Î™');
            
            // Final grades key
            const finalKey = `${classId}_${studentRegNo}`;

            container.innerHTML = `
                <div class="student-card-header">
                    <div class="student-card-name">${student.name}</div>
                    <div class="student-card-class">${className} â€¢ Î£Ï‡Î¿Î»Î¹ÎºÏŒ ÎˆÏ„Î¿Ï‚ 2025-2026</div>
                </div>

                ${isLyceum ? `
                <div class="select-group" style="margin: 15px 0;">
                    <label class="select-label">ÎšÎ»Î¯Î¼Î±ÎºÎ± Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚ Î¤ÎµÎ»Î¹ÎºÏÎ½</label>
                    <div class="scale-toggle">
                        <button class="scale-btn active" id="card-scale-20-btn" onclick="setCardScale(20)">
                            <span class="scale-number">0-20</span>
                            <span class="scale-desc">Î•Î¹ÎºÎ¿ÏƒÎ±Î²Î¬Î¸Î¼Î¹Î±</span>
                        </button>
                        <button class="scale-btn" id="card-scale-100-btn" onclick="setCardScale(100)">
                            <span class="scale-number">0-100</span>
                            <span class="scale-desc">Î•ÎºÎ±Ï„Î¿Î½Ï„Î±Î²Î¬Î¸Î¼Î¹Î±</span>
                        </button>
                    </div>
                </div>
                ` : ''}

                ${subjects.map(subject => {
                    const subjectGrades = studentGrades.filter(g => g.subject === subject);
                    
                    // Filter by period
                    const trimesterGrades = subjectGrades.filter(g => {
                        const gDate = new Date(g.date);
                        return gDate >= new Date('2025-09-01') && gDate <= new Date('2025-12-31') && g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£';
                    });
                    
                    const tetramesterGrades = subjectGrades.filter(g => {
                        const gDate = new Date(g.date);
                        return gDate >= new Date('2026-01-01') && gDate <= new Date('2026-05-31') && g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£';
                    });

                    const examGrades = subjectGrades.filter(g => g.category === 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£');

                    // Calculate averages
                    const calcAvg = (arr) => {
                        if (arr.length === 0) return '-';
                        const normalized = arr.map(g => g.scale === 100 ? g.score / 5 : g.score);
                        return (normalized.reduce((a, b) => a + b, 0) / normalized.length).toFixed(1);
                    };

                    const trimesterAvg = calcAvg(trimesterGrades);
                    const tetramesterAvg = calcAvg(tetramesterGrades);
                    const examScore = examGrades.length > 0 ? examGrades[examGrades.length - 1].score : '-';

                    // Get saved final grades (check both formats)
                    const fk = finalGrades[finalKey] || {};
                    const savedTrimester = fk[`${subject}_trimester`] || finalGrades[`${finalKey}_${subject}_trimester`] || '';
                    const savedTetramester = fk[`${subject}_tetramester`] || finalGrades[`${finalKey}_${subject}_tetramester`] || '';
                    const savedYear = fk[`${subject}_year`] || finalGrades[`${finalKey}_${subject}_year`] || '';

                    const subjectId = subject.replace(/\s/g, '_');
                    
                    // Max value based on scale (default 20)
                    const maxVal = isLyceum ? '" data-max-20="20" data-max-100="100"' : '';

                    return `
                        <div class="subject-card">
                            <div class="subject-header">
                                <span class="subject-name">${subject}</span>
                            </div>
                            
                            <!-- Î‘Î„ Î¤ÏÎ¯Î¼Î·Î½Î¿ -->
                            <div class="period-section">
                                <div class="period-header">
                                    <span class="period-title">Î‘Î„ Î¤Î¡Î™ÎœÎ—ÎÎŸ</span>
                                    <span class="period-avg">Îœ.ÎŸ.: ${trimesterAvg}</span>
                                </div>
                                <div class="period-grades">
                                    ${trimesterGrades.length > 0 ? `
                                        <div class="grades-list">
                                            ${groupGradesByCategory(trimesterGrades)}
                                        </div>
                                    ` : '<div class="no-grades-text">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î²Î±Î¸Î¼Î¿Î¯</div>'}
                                </div>
                                <div class="period-final">
                                    <span>Î’Î±Î¸Î¼ÏŒÏ‚ Î¤ÏÎ¹Î¼Î®Î½Î¿Ï…:</span>
                                    <input type="number" class="final-grade-input small card-final-input" 
                                           id="final-${subjectId}-trimester"
                                           value="${savedTrimester}"
                                           min="0" max="20" step="0.5" placeholder="â€”"${maxVal}>
                                </div>
                            </div>

                            <!-- Î’Î„ Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿ -->
                            <div class="period-section">
                                <div class="period-header">
                                    <span class="period-title">Î’Î„ Î¤Î•Î¤Î¡Î‘ÎœÎ—ÎÎŸ</span>
                                    <span class="period-avg">Îœ.ÎŸ.: ${tetramesterAvg}</span>
                                </div>
                                <div class="period-grades">
                                    ${tetramesterGrades.length > 0 ? `
                                        <div class="grades-list">
                                            ${groupGradesByCategory(tetramesterGrades)}
                                        </div>
                                    ` : '<div class="no-grades-text">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î²Î±Î¸Î¼Î¿Î¯</div>'}
                                </div>
                                <div class="period-final">
                                    <span>Î’Î±Î¸Î¼ÏŒÏ‚ Î¤ÎµÏ„ÏÎ±Î¼Î®Î½Î¿Ï…:</span>
                                    <input type="number" class="final-grade-input small card-final-input" 
                                           id="final-${subjectId}-tetramester"
                                           value="${savedTetramester}"
                                           min="0" max="20" step="0.5" placeholder="â€”"${maxVal}>
                                </div>
                            </div>

                            <!-- Î•Î¾ÎµÏ„Î¬ÏƒÎµÎ¹Ï‚ -->
                            <div class="period-section exam-section">
                                <div class="period-header exam-header">
                                    <span class="period-title">Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£</span>
                                    <span class="exam-score">${examScore !== '-' ? examScore : 'â€”'}</span>
                                </div>
                            </div>

                            <!-- Î¤ÎµÎ»Î¹ÎºÏŒÏ‚ Î’Î±Î¸Î¼ÏŒÏ‚ ÎˆÏ„Î¿Ï…Ï‚ -->
                            <div class="year-final-section">
                                <span class="year-final-label">Î¤Î•Î›Î™ÎšÎŸÎ£ Î’Î‘Î˜ÎœÎŸÎ£ Î•Î¤ÎŸÎ¥Î£</span>
                                <input type="number" class="final-grade-input large card-final-input" 
                                       id="final-${subjectId}-year"
                                       value="${savedYear}"
                                       min="0" max="20" step="0.5" placeholder="â€”"${maxVal}>
                            </div>
                        </div>
                    `;
                }).join('')}

                <button class="save-finals-btn" onclick="saveFinalGrades()">
                    ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÎŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î’Î±Î¸Î¼ÏÎ½
                </button>
            `;
        }

        function groupGradesByCategory(gradesArr) {
            const byCategory = {};
            gradesArr.forEach(g => {
                if (!byCategory[g.category]) byCategory[g.category] = [];
                byCategory[g.category].push(g);
            });

            return Object.entries(byCategory).map(([cat, catGrades]) => `
                <div class="category-row">
                    <span class="category-name">${cat}</span>
                    <div class="category-grades">
                        ${catGrades.map(g => `
                            <div class="grade-chip">
                                <span class="grade-chip-score">${g.score}${g.scale === 100 ? '/100' : ''}</span>
                                <span class="grade-chip-date">${new Date(g.date).toLocaleDateString('el-GR', {day:'numeric', month:'short'})}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

function saveFinalGrades() {
            const studentRegNo = document.getElementById('card-student').value;
            const classId = document.getElementById('card-class').value;
            if (!studentRegNo || !classId) { showToast('âš  Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î· ÎºÎ±Î¹ Î¼Î±Î¸Î·Ï„Î®/Ï„ÏÎ¹Î±'); return; }

            const finals = loadFinalGrades_();
            const finalKey = `${classId}_${studentRegNo}`;
            if (!finals[finalKey]) finals[finalKey] = {};

            const cls = classes.find(c => c.id === classId);
            const stu = students.find(s => s.regNo === studentRegNo && s.classId === classId);
            const className = cls ? cls.name : classId;
            const studentName = stu ? stu.name : studentRegNo;
            
            // Use cardScale for final grades (default 20)
            const scaleToUse = cardScale || 20;
            
            const savedAt = new Date().toISOString();

            let wroteAny = false;

            subjects.forEach((subjectName, subjectIndex) => {
                const subjectId = subjectName.replace(/\s/g, '_');
                // Unified ID generation (same logic as single-grade save)
                const gidFor = (categoryLabel) => makeGradeId({
                    classId,
                    SCHOOL_YEAR,
                    studentRegistryNo: studentRegNo,
                    subjectName,
                    category: categoryLabel
                });
                
                // Î¤ÏÎ¯Î¼Î·Î½Î¿
                const trimesterInput = document.getElementById(`final-${subjectId}-trimester`);
                if (trimesterInput) {
                    const raw = (trimesterInput.value || '').trim();
                    finals[finalKey][`${subjectName}_trimester`] = raw;
                    
                    if (raw !== '') {
                        const score = parseFloat(raw.replace(',', '.'));
                        if (!Number.isNaN(score)) {
                            wroteAny = true;
                            const gid = gidFor('Î‘Î„ Î¤ÏÎ¯Î¼Î·Î½Î¿');
                            const gradeRow = {
                                id: gid, classId, className, studentRegNo, studentName,
                                subjectId: subjectName, subject: subjectName,
                                categoryId: 'final_trimester', category: 'Î‘Î„ Î¤ÏÎ¯Î¼Î·Î½Î¿',
                                score: score, scale: scaleToUse, notes: 'Î¤ÎµÎ»Î¹ÎºÏŒÏ‚',
                                date: '2025-12-31', savedAt: savedAt, synced: false, hideFromHistory: true
                            };
                            const idx = grades.findIndex(g => String(g.id) === String(gid));
                            if (idx >= 0) { grades[idx] = { ...grades[idx], ...gradeRow }; }
                            else { grades.push(gradeRow); }
                            try { saveGradebook_(); syncToGoogleSheets(gradeRow, idx >= 0 ? 'update' : 'create'); } catch(e) {}
                        }
                    }
                }
                
                // Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿
                const tetramesterInput = document.getElementById(`final-${subjectId}-tetramester`);
                if (tetramesterInput) {
                    const raw = (tetramesterInput.value || '').trim();
                    finals[finalKey][`${subjectName}_tetramester`] = raw;
                    
                    if (raw !== '') {
                        const score = parseFloat(raw.replace(',', '.'));
                        if (!Number.isNaN(score)) {
                            wroteAny = true;
                            const gid = gidFor('Î’Î„ Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿');
                            const gradeRow = {
                                id: gid, classId, className, studentRegNo, studentName,
                                subjectId: subjectName, subject: subjectName,
                                categoryId: 'final_tetramester', category: 'Î’Î„ Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿',
                                score: score, scale: scaleToUse, notes: 'Î¤ÎµÎ»Î¹ÎºÏŒÏ‚',
                                date: '2026-05-31', savedAt: savedAt, synced: false, hideFromHistory: true
                            };
                            const idx = grades.findIndex(g => String(g.id) === String(gid));
                            if (idx >= 0) { grades[idx] = { ...grades[idx], ...gradeRow }; }
                            else { grades.push(gradeRow); }
                            try { saveGradebook_(); syncToGoogleSheets(gradeRow, idx >= 0 ? 'update' : 'create'); } catch(e) {}
                        }
                    }
                }
                
                // ÎˆÏ„Î¿Ï…Ï‚
                const yearInput = document.getElementById(`final-${subjectId}-year`);
                if (yearInput) {
                    const raw = (yearInput.value || '').trim();
                    finals[finalKey][`${subjectName}_year`] = raw;
                    
                    if (raw !== '') {
                        const score = parseFloat(raw.replace(',', '.'));
                        if (!Number.isNaN(score)) {
                            wroteAny = true;
                            const gid = gidFor('Î¤ÎµÎ»Î¹ÎºÏŒÏ‚ ÎˆÏ„Î¿Ï…Ï‚');
                            const gradeRow = {
                                id: gid, classId, className, studentRegNo, studentName,
                                subjectId: subjectName, subject: subjectName,
                                categoryId: 'final_year', category: 'Î¤ÎµÎ»Î¹ÎºÏŒÏ‚ ÎˆÏ„Î¿Ï…Ï‚',
                                score: score, scale: scaleToUse, notes: 'Î¤ÎµÎ»Î¹ÎºÏŒÏ‚',
                                date: new Date().toISOString().slice(0,10), savedAt: savedAt, synced: false, hideFromHistory: true
                            };
                            const idx = grades.findIndex(g => String(g.id) === String(gid));
                            if (idx >= 0) { grades[idx] = { ...grades[idx], ...gradeRow }; }
                            else { grades.push(gradeRow); }
                            try { saveGradebook_(); syncToGoogleSheets(gradeRow, idx >= 0 ? 'update' : 'create'); } catch(e) {}
                        }
                    }
                }
            });

            // Update the in-memory finalGrades object
            Object.assign(finalGrades, finals);
            
            try { localStorage.setItem(FINAL_GRADES_KEY, JSON.stringify(finals)); } catch(e) {}

            showToast(wroteAny ? 'âœ“ Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½ Î¿Î¹ Ï„ÎµÎ»Î¹ÎºÎ¿Î¯ Î²Î±Î¸Î¼Î¿Î¯ (ÎºÎ±Î¹ Î³ÏÎ¬Ï†Ï„Î·ÎºÎ±Î½ ÏƒÏ„Î· Î²Î¬ÏƒÎ·)' : 'âœ“ Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½ Î¿Î¹ Ï„ÎµÎ»Î¹ÎºÎ¿Î¯ Î²Î±Î¸Î¼Î¿Î¯');
        }

        // ============== REPORTS ==============
        function generateReport(type) {
            const modal = document.getElementById('report-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            if (type === 'student') {
                modalTitle.textContent = 'Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎœÎ±Î¸Î·Ï„Î®';
                modalBody.innerHTML = `
                    <div class="select-group">
                        <label class="select-label">Î¤Î¬Î¾Î·</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="report-class" onchange="updateReportStudents()">
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·...</option>
                                ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                    <div class="select-group">
                        <label class="select-label">ÎœÎ±Î¸Î·Ï„Î®Ï‚</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="report-student" disabled>
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÏÏ„Î± Ï„Î¬Î¾Î·...</option>
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                    <button class="submit-btn" onclick="createStudentReport()">
                        <span>ğŸ“„</span>
                        <span>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF</span>
                    </button>
                `;
            } else if (type === 'studentGrid') {
                modalTitle.textContent = 'Î‘Ï„Î¿Î¼Î¹ÎºÏŒ Î”ÎµÎ»Ï„Î¯Î¿ (Landscape)';
                modalBody.innerHTML = `
                    <div class="select-group">
                        <label class="select-label">Î¤Î¬Î¾Î·</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="report-class-grid-student" onchange="updateReportStudentsGrid()">
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·...</option>
                                ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                    <div class="select-group">
                        <label class="select-label">ÎœÎ±Î¸Î·Ï„Î®Ï‚</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="report-student-grid" disabled>
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÏÏ„Î± Ï„Î¬Î¾Î·...</option>
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                    <button class="submit-btn" onclick="createStudentGridReport()">
                        <span>ğŸ“‹</span>
                        <span>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF (Landscape)</span>
                    </button>
                `;
	            } else if (type === 'studentFinal') {
	                modalTitle.textContent = 'ÎšÎ±ÏÏ„Î­Î»Î± ÎœÎ±Î¸Î·Ï„Î® - Î¤ÎµÎ»Î¹ÎºÎ¿Î¯ Î’Î±Î¸Î¼Î¿Î¯';
	                modalBody.innerHTML = `
	                    <div class="select-group">
	                        <label class="select-label">Î¤Î¬Î¾Î·</label>
	                        <div class="select-wrapper">
	                            <select class="custom-select" id="report-class-final-student" onchange="updateStudentsInReports('finalStudent')">
	                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·...</option>
	                                ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
	                            </select>
	                            <span class="select-arrow">â–¼</span>
	                        </div>
	                    </div>
	                    <div class="select-group">
	                        <label class="select-label">ÎœÎ±Î¸Î·Ï„Î®Ï‚/Ï„ÏÎ¹Î±</label>
	                        <div class="select-wrapper">
	                            <select class="custom-select" id="report-student-final">
	                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÏÏ„Î± Ï„Î¬Î¾Î·...</option>
	                            </select>
	                            <span class="select-arrow">â–¼</span>
	                        </div>
	                    </div>
	                    <button type="button" class="submit-btn" onclick="createStudentFinalReport()">
	                        <span>âœ…</span>
	                        <span>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF</span>
	                    </button>
	                `;
            } else if (type === 'class') {
                modalTitle.textContent = 'ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¤Î¬Î¾Î·Ï‚';
                modalBody.innerHTML = `
                    <div class="select-group">
                        <label class="select-label">Î¤Î¬Î¾Î·</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="report-class-only">
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·...</option>
                                ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                    <button class="submit-btn" onclick="createClassReport()">
                        <span>ğŸ“Š</span>
                        <span>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF</span>
                    </button>
                `;
            } else if (type === 'classGrid') {
                modalTitle.textContent = 'Î Î¯Î½Î±ÎºÎ±Ï‚ Î¤Î¼Î®Î¼Î±Ï„Î¿Ï‚ (Landscape)';
                modalBody.innerHTML = `
                    <div class="select-group">
                        <label class="select-label">Î¤Î¬Î¾Î·</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="report-class-grid">
                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·...</option>
                                ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                    <div class="select-group">
                        <label class="select-label">ÎœÎ¬Î¸Î·Î¼Î±</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="report-subject-grid">
                                <option value="">ÎŒÎ»Î± Ï„Î± Î¼Î±Î¸Î®Î¼Î±Ï„Î±</option>
                                ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                    <button class="submit-btn" onclick="createClassGridReport()">
                        <span>ğŸ“‹</span>
                        <span>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF (Landscape)</span>
                    </button>
                `;
	            } else if (type === 'classFinal') {
	                modalTitle.textContent = 'ÎšÎ±ÏÏ„Î­Î»Î± Î‘Î½Î¬ Î¤Î¬Î¾Î· - Î¤ÎµÎ»Î¹ÎºÎ¿Î¯ Î’Î±Î¸Î¼Î¿Î¯';
	                modalBody.innerHTML = `
	                    <div class="select-group">
	                        <label class="select-label">Î¤Î¬Î¾Î·</label>
	                        <div class="select-wrapper">
	                            <select class="custom-select" id="report-class-final">
	                                <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·...</option>
	                                ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
	                            </select>
	                            <span class="select-arrow">â–¼</span>
	                        </div>
	                    </div>
	                    <button type="button" class="submit-btn" onclick="createClassFinalReport()">
	                        <span>âœ…</span>
	                        <span>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF (Landscape)</span>
	                    </button>
	                `;
            } else {
                modalTitle.textContent = 'Î‘Î½Î±Ï†Î¿ÏÎ¬ Î ÎµÏÎ¹ÏŒÎ´Î¿Ï…';
                modalBody.innerHTML = `
                    <div class="select-group">
                        <label class="select-label">Î ÎµÏÎ¯Î¿Î´Î¿Ï‚</label>
                        <div class="select-wrapper">
                            <select class="custom-select" id="report-period">
                                <option value="1">Î‘Î„ Î¤ÏÎ¯Î¼Î·Î½Î¿ (Î£ÎµÏ€-Î”ÎµÎº)</option>
                                <option value="2">Î’Î„ Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿ (Î™Î±Î½-ÎœÎ¬Î¹)</option>
                            </select>
                            <span class="select-arrow">â–¼</span>
                        </div>
                    </div>
                    <button class="submit-btn" onclick="createPeriodReport()">
                        <span>ğŸ“…</span>
                        <span>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF</span>
                    </button>
                `;
            }

            modal.classList.add('active');
        }

        function updateReportStudents() {
            const classId = document.getElementById('report-class').value;
            const studentSelect = document.getElementById('report-student');
            
            studentSelect.innerHTML = '<option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î±Î¸Î·Ï„Î®...</option>';
            
            if (classId) {
                studentSelect.disabled = false;
                const classStudents = students
                    .filter(s => s.classId === classId)
                    .sort((a, b) => a.name.localeCompare(b.name, 'el'));
                
                classStudents.forEach(s => {
                    studentSelect.innerHTML += `<option value="${s.regNo}">${s.name}</option>`;
                });
            } else {
                studentSelect.disabled = true;
            }
        }

        function updateReportStudentsGrid() {
            const classId = document.getElementById('report-class-grid-student').value;
            const studentSelect = document.getElementById('report-student-grid');
            
            studentSelect.innerHTML = '<option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î±Î¸Î·Ï„Î®...</option>';
            
            if (classId) {
                studentSelect.disabled = false;
                const classStudents = students
                    .filter(s => s.classId === classId)
                    .sort((a, b) => a.name.localeCompare(b.name, 'el'));
                
                classStudents.forEach(s => {
                    studentSelect.innerHTML += `<option value="${s.regNo}">${s.name}</option>`;
                });
            } else {
                studentSelect.disabled = true;
            }
        }

        // -------------------------------------------------
        // REPORTS: FINAL GRADES (Student Card)
        // -------------------------------------------------
        function updateReportStudentsFinal(){
            const classSel = document.getElementById('report-class-final-student');
            const studentSelect = document.getElementById('report-student-final');
            if (!classSel || !studentSelect) return;

            const classId = classSel.value;
            studentSelect.innerHTML = '<option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î±Î¸Î·Ï„Î®...</option>';

            if (!classId) {
                // Keep only the placeholder when no class is selected
                return;
            }

            const classStudents = students
                .filter(s => s.classId === classId)
                .slice()
                .sort((a,b) => String(a.name).localeCompare(String(b.name), 'el'));

            classStudents.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.regNo;
                opt.textContent = `${s.name} (${s.regNo})`;
                studentSelect.appendChild(opt);
            });
        }

        // Populate students for FINAL GRADES (Student Card - Finals)
        function updateReportStudentsFinal(){
            const classId = document.getElementById('report-class-final-student')?.value;
            const studentSelect = document.getElementById('report-student-final');
            if (!studentSelect) return;

            studentSelect.innerHTML = '<option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÏÏ„Î± Ï„Î¬Î¾Î·...</option>';
            if (!classId) return;

            const classStudents = students.filter(s => s.classId === classId);
            classStudents.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.regNo;
                opt.textContent = `${s.name} (${s.regNo})`;
                studentSelect.appendChild(opt);
            });
        }

        // A small router so the HTML can call a single onchange handler.
        function updateStudentsInReports(kind){
            try {
                if (kind === 'grid') return updateReportStudentsGrid();
                if (kind === 'finalStudent') return updateReportStudentsFinal();
                return updateReportStudents();
            } catch (e) {
                console.error('updateStudentsInReports error:', e);
            }
        }

        function createStudentGridReport() {
            const classId = document.getElementById('report-class-grid-student').value;
            const studentRegNo = document.getElementById('report-student-grid').value;
            
            if (!classId || !studentRegNo) {
                showToast('Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î· ÎºÎ±Î¹ Î¼Î±Î¸Î·Ï„Î®');
                return;
            }

            
            const reportGrades = getGradesForReports();
const student = students.find(s => s.regNo === studentRegNo && s.classId === classId);
            const className = classes.find(c => c.id === classId)?.name;
            const studentGrades = reportGrades.filter(g => g.studentRegNo === studentRegNo && g.classId === classId);
            const finalKey = `${classId}_${studentRegNo}`;

            const calcAvg = (arr) => {
                if (arr.length === 0) return '-';
                const normalized = arr.map(g => g.scale === 100 ? g.score / 5 : g.score);
                return (normalized.reduce((a, b) => a + b, 0) / normalized.length).toFixed(1);
            };

            // Categories without Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£ for period columns
            const periodCategories = categories.filter(c => c !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£');

            // Build data for each subject
            const subjectData = subjects.map(subject => {
                const subjectGrades = studentGrades.filter(g => g.subject === subject);
                
                // Trimester grades by category
                const trimesterGrades = subjectGrades.filter(g => {
                    const gDate = new Date(g.date);
                    return gDate >= new Date('2025-09-01') && gDate <= new Date('2025-12-31') && g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£';
                });
                
                // Tetramester grades by category
                const tetramesterGrades = subjectGrades.filter(g => {
                    const gDate = new Date(g.date);
                    return gDate >= new Date('2026-01-01') && gDate <= new Date('2026-05-31') && g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£';
                });

                // Exam grades
                const examGrades = subjectGrades.filter(g => g.category === 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£');

                const row = { subject };
                
                // Trimester category averages
                periodCategories.forEach(cat => {
                    const catGrades = trimesterGrades.filter(g => g.category === cat);
                    row[`tri_${cat}`] = calcAvg(catGrades);
                });
                row.tri_avg = calcAvg(trimesterGrades);
                row.tri_final = getFinalGrade(classId, studentRegNo, subject, 'trimester') || '-';

                // Tetramester category averages
                periodCategories.forEach(cat => {
                    const catGrades = tetramesterGrades.filter(g => g.category === cat);
                    row[`tet_${cat}`] = calcAvg(catGrades);
                });
                row.tet_avg = calcAvg(tetramesterGrades);
                row.tet_final = getFinalGrade(classId, studentRegNo, subject, 'tetramester') || '-';

                // Exam and Year Final
                row.exam = examGrades.length > 0 ? examGrades[examGrades.length - 1].score : '-';
                row.year_final = getFinalGrade(classId, studentRegNo, subject, 'year') || '-';

                return row;
            });

            // Overall averages
            const allTrimester = studentGrades.filter(g => {
                const gDate = new Date(g.date);
                return gDate >= new Date('2025-09-01') && gDate <= new Date('2025-12-31') && g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£';
            });
            const allTetramester = studentGrades.filter(g => {
                const gDate = new Date(g.date);
                return gDate >= new Date('2026-01-01') && gDate <= new Date('2026-05-31') && g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£';
            });

            const overallTrimesterAvg = calcAvg(allTrimester);
            const overallTetramesterAvg = calcAvg(allTetramester);
            
            // Calculate overall year final from manual grades
            const fg = finalGrades[finalKey] || {};
            const yearFinals = subjects.map(s => parseFloat(fg[`${s}_year`])).filter(v => !isNaN(v));
            const overallYearFinal = yearFinals.length > 0 
                ? (yearFinals.reduce((a, b) => a + b, 0) / yearFinals.length).toFixed(1) 
                : '-';

            // Generate landscape PDF
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Î‘Ï„Î¿Î¼Î¹ÎºÏŒ Î”ÎµÎ»Ï„Î¯Î¿ - ${student.name}</title>
                    <style>
                        @page { size: A4 landscape; margin: 8mm; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 8px; padding: 10px; }
                        .header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid #5B2C83; padding-bottom: 8px; }
                        .header h1 { color: #5B2C83; font-size: 14px; margin-bottom: 3px; }
                        .student-box { background: #5B2C83; color: white; padding: 8px 15px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; }
                        .student-name { font-size: 14px; font-weight: 700; }
                        .student-meta { font-size: 10px; opacity: 0.9; }
                        table { width: 100%; border-collapse: collapse; font-size: 7px; }
                        th { background: #5B2C83; color: white; padding: 4px 2px; text-align: center; font-weight: 600; font-size: 6px; }
                        th.period-title { background: #e8d5f2; color: #5B2C83; font-size: 8px; font-weight: 700; }
                        th:first-child { text-align: left; min-width: 60px; }
                        td { padding: 5px 2px; border-bottom: 1px solid #ddd; text-align: center; font-size: 7px; }
                        td:first-child { text-align: left; font-weight: 500; background: #f8f5fc; font-size: 8px; }
                        tr:nth-child(even) td:not(:first-child) { background: #fafafa; }
                        .avg-col { background: #e8d5f2 !important; font-weight: 600; }
                        .final-col { background: #d4c4e3 !important; font-weight: 700; color: #5B2C83; }
                        .exam-col { background: #fff3cd !important; color: #856404; font-weight: 600; }
                        .year-col { background: #5B2C83 !important; color: white !important; font-weight: 700; }
                        .summary { display: flex; justify-content: center; gap: 20px; margin-top: 10px; padding: 10px; background: #f8f5fc; border-radius: 6px; }
                        .summary-item { text-align: center; }
                        .summary-value { font-size: 20px; font-weight: 700; color: #5B2C83; }
                        .summary-value.final { background: #5B2C83; color: white; padding: 5px 15px; border-radius: 6px; }
                        .summary-label { font-size: 8px; color: #666; }
                        .footer { margin-top: 8px; text-align: right; font-size: 7px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ÎœÎŸÎ¥Î£Î™ÎšÎŸ Î£Î§ÎŸÎ›Î•Î™ÎŸ Î›Î•Î¥ÎšÎ‘Î”Î‘Î£ - Î‘Ï„Î¿Î¼Î¹ÎºÏŒ Î”ÎµÎ»Ï„Î¯Î¿ Î ÏÎ¿ÏŒÎ´Î¿Ï…</h1>
                    </div>

                    <div class="student-box">
                        <div>
                            <div class="student-name">${student.name}</div>
                            <div class="student-meta">${className} â€¢ Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…: ${student.regNo}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="student-meta">Î£Ï‡Î¿Î»Î¹ÎºÏŒ ÎˆÏ„Î¿Ï‚ 2025-2026</div>
                            <div class="student-meta">${new Date().toLocaleDateString('el-GR')}</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th rowspan="2">ÎœÎ‘Î˜Î—ÎœÎ‘</th>
                                <th colspan="${periodCategories.length + 2}" class="period-title">Î‘Î„ Î¤Î¡Î™ÎœÎ—ÎÎŸ</th>
                                <th colspan="${periodCategories.length + 2}" class="period-title">Î’Î„ Î¤Î•Î¤Î¡Î‘ÎœÎ—ÎÎŸ</th>
                                <th rowspan="2" class="exam-col">Î•ÎÎ•Î¤.</th>
                                <th rowspan="2" class="year-col">Î¤Î•Î›Î™ÎšÎŸÎ£</th>
                            </tr>
                            <tr>
                                ${periodCategories.map(c => `<th>${c.substring(0,4)}</th>`).join('')}
                                <th class="avg-col">Îœ.ÎŸ.Îœ.</th>
                                <th class="final-col">Î’Î±Î¸Î¼.</th>
                                ${periodCategories.map(c => `<th>${c.substring(0,4)}</th>`).join('')}
                                <th class="avg-col">Îœ.ÎŸ.Îœ.</th>
                                <th class="final-col">Î’Î±Î¸Î¼.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${subjectData.map(row => `
                                <tr>
                                    <td>${row.subject}</td>
                                    ${periodCategories.map(c => `<td>${row[`tri_${c}`]}</td>`).join('')}
                                    <td class="avg-col">${row.tri_avg}</td>
                                    <td class="final-col">${row.tri_final}</td>
                                    ${periodCategories.map(c => `<td>${row[`tet_${c}`]}</td>`).join('')}
                                    <td class="avg-col">${row.tet_avg}</td>
                                    <td class="final-col">${row.tet_final}</td>
                                    <td class="exam-col">${row.exam}</td>
                                    <td class="year-col">${row.year_final}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="summary">
                        <div class="summary-item">
                            <div class="summary-value">${overallTrimesterAvg}</div>
                            <div class="summary-label">Îœ.ÎŸ. ÎœÎ‘Î˜Î—Î¤Î— Î¤Î¡Î™ÎœÎ—ÎÎŸÎ¥</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${overallTetramesterAvg}</div>
                            <div class="summary-label">Îœ.ÎŸ. ÎœÎ‘Î˜Î—Î¤Î— Î¤Î•Î¤Î¡Î‘ÎœÎ—ÎÎŸÎ¥</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value final">${overallYearFinal}</div>
                            <div class="summary-label">Î¤Î•Î›Î™ÎšÎŸÎ£ Î’Î‘Î˜ÎœÎŸÎ£ Î•Î¤ÎŸÎ¥Î£</div>
                        </div>
                    </div>

                    <div class="footer">
                        Î•ÎºÏ„Ï…Ï€ÏÎ¸Î·ÎºÎµ: ${new Date().toLocaleString('el-GR')} | Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î¹Î¿ - ÎœÏ€Î¯Î¶Î¿Ï… Î”Î¹Î¿Î½Ï…ÏƒÎ¯Î±
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            reportWindow.document.close();
            
            showToast('âœ“ Î¤Î¿ Î´ÎµÎ»Ï„Î¯Î¿ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ!');
            closeModal();
        }

        // =================================================
        // FINAL GRADES ONLY REPORTS (Manual finals from Student Card)
        // =================================================
        
function _openReportWindow(title, htmlBody) {
    // NOTE: Î£Îµ mobile/PWA, Ï„Î± pop-ups ÏƒÏ…Ï‡Î½Î¬ Î¼Ï€Î»Î¿ÎºÎ¬ÏÎ¿Î½Ï„Î±Î¹.
    // 1) Î ÏÎ¿ÏƒÏ€Î±Î¸Î¿ÏÎ¼Îµ popup. 2) Î‘Î½ Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹, Î±Î½Î¿Î¯Î³Î¿Ï…Î¼Îµ Î±ÏƒÏ†Î±Î»Î­Ï‚ print-preview ÏƒÏ„Î¿ Î™Î”Î™ÎŸ tab Î¼Î­ÏƒÏ‰ Blob URL.

    const fullHtml = `<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>${title || 'Î‘Î½Î±Ï†Î¿ÏÎ¬'}</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; margin:0; padding:0; }
  .printbar { position: sticky; top:0; z-index:9999; display:flex; gap:10px; align-items:center; padding:12px 14px; background:#ffffff; border-bottom:1px solid #e9e9ef; }
  .printbar button { appearance:none; border:1px solid #d6d6e6; background:#f7f7fb; padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer; }
  .printbar button.primary { background:#5B2C83; color:#fff; border-color:#4b1f70; }
  .printbar .hint { margin-left:auto; color:#666; font-size:12px; }
  @media print { .printbar { display:none !important; } }
</style>
</head>
<body>
<div class="printbar">
  <button class="primary" onclick="window.print()">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· / Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· PDF</button>
  <button id="btnBack" style="display:none" onclick="(function(){try{var u=sessionStorage.getItem('bizou_return_url'); if(u){sessionStorage.removeItem('bizou_return_url'); location.href=u; return;} }catch(e){} history.back();})()">Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®</button>
  <div class="hint">Î‘Î½ Î´ÎµÎ½ ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿, ÎºÎ¬Î½Îµ scroll ÎºÎ±Î¹ Ï€Î¬Ï„Î± Â«Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· / PDFÂ».</div>
</div>
${htmlBody}
<script>(function(){try{var u=sessionStorage.getItem('bizou_return_url'); if(u){document.getElementById('btnBack').style.display='inline-block';}}catch(e){}})();<\/script>
</body>
</html>`;

    // 1) Popup (desktop-friendly)
    try {
        const w = window.open('', '_blank');
        if (w && w.document) {
            w.document.open();
            w.document.write(fullHtml);
            w.document.close();
            return w;
        }
    } catch (e) {
        // ignore
    }

    // 2) Fallback: same-tab print preview via Blob URL
    try {
        try { sessionStorage.setItem('bizou_return_url', location.href); } catch (e) {}
        const blob = new Blob([fullHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        // Î£Îµ PWA/ÎºÎ¹Î½Î·Ï„ÏŒ, Î±Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Ï€Î¹Î¿ Î±Î¾Î¹ÏŒÏ€Î¹ÏƒÏ„Î¿.
        location.href = url;
        return null;
    } catch (e) {
        alert('Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Î±Î½Î¿Î¯Î¾Ï‰ Ï„Î·Î½ Î±Î½Î±Ï†Î¿ÏÎ¬ Î³Î¹Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·. Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¹Ï‚ Î¬Î´ÎµÎ¹ÎµÏ‚ (pop-ups) Î® Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¬Î»Î»Î¿ browser.');
        return null;
    }
}

// ------------------------------------------------------------
// Helper: escape HTML for safe print-preview rendering
// (Used by the new â€œFinal Gradesâ€ printouts.)
// ------------------------------------------------------------
function escapeHtml(value) {
    const s = String(value ?? '');
    return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}



// Helper: DB-backed finals for reports (so reports keep working even if localStorage/history is cleared)
function getLatestFinalFromDb(classId, studentRegNo, subject){
  try {
    if (!Array.isArray(grades)) return null;
    const sid = String(studentRegNo);
    const rows = grades.filter(g => String(g.studentRegNo) === sid && g.classId === classId && g.subject === subject && g.category === 'Î¤Î•Î›Î™ÎšÎŸÎ£');
    if (!rows.length) return null;
    rows.sort((a,b) => new Date(a.date || 0) - new Date(b.date || 0));
    const last = rows[rows.length - 1];
    const n = parseFloat(String(last.score).replace(',', '.'));
    return Number.isFinite(n) ? n : null;
  } catch (e) { return null; }
}

function formatFinalNumber(n){
  if (n === null || n === undefined || !Number.isFinite(n)) return 'â€“';
  // keep 1 decimal when needed, but avoid trailing .0
  const s = (Math.round(n * 10) / 10).toFixed(1);
  return s.endsWith('0') ? String(parseInt(s,10)) : s.replace('.', ',');
}

function createStudentFinalReport() {
            const classId = document.getElementById('report-class-final-student')?.value;
            const studentRegNo = document.getElementById('report-student-final')?.value;
            if (!classId || !studentRegNo) {
                showToast('Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î· ÎºÎ±Î¹ Î¼Î±Î¸Î·Ï„Î®');
                return;
            }
            const student = students.find(s => s.regNo === studentRegNo && s.classId === classId);
            const className = classes.find(c => c.id === classId)?.name || '';
            if (!student) {
                showToast('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î¼Î±Î¸Î·Ï„Î®Ï‚.');
                return;
            }

            const finalKey = classId + '_' + studentRegNo;
            const rows = subjects.map(sub => {
                const raw = getLatestFinalFromDb(classId, studentRegNo, sub);
                const num = (raw === undefined || raw === null || raw === '') ? null : Number(raw);
                const display = (num === null || Number.isNaN(num)) ? '-' : (Number.isInteger(num) ? String(num) : num.toFixed(1).replace('.', ','));
                return { subject: sub, val: display, num: (num === null || Number.isNaN(num)) ? null : num };
            });
            const nums = rows.map(r => r.num).filter(n => n !== null);
            const avg = nums.length ? (nums.reduce((a,b)=>a+b,0) / nums.length) : null;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Î¤ÎµÎ»Î¹ÎºÎ¿Î¯ Î’Î±Î¸Î¼Î¿Î¯ - ${student.name}</title>
                    <style>
                        @page { size: A4; margin: 12mm; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; padding: 20px; color: #333; }
                        .header { text-align: center; border-bottom: 3px solid #5B2C83; padding-bottom: 15px; margin-bottom: 20px; }
                        .header h1 { color: #5B2C83; font-size: 18px; margin-bottom: 5px; }
                        .header h2 { color: #666; font-size: 14px; font-weight: normal; }
                        .student-info { background: #f8f5fc; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #5B2C83; }
                        .student-info h3 { color: #5B2C83; font-size: 16px; margin-bottom: 10px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
                        .info-item { font-size: 11px; }
                        .info-label { color: #666; }
                        .info-value { font-weight: 600; }
                        
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th { background: #5B2C83; color: white; padding: 12px 15px; text-align: left; font-weight: 600; font-size: 12px; }
                        td { padding: 12px 15px; border-bottom: 1px solid #e8d5f2; font-size: 11px; }
                        tr:nth-child(even) { background: #faf8fc; }
                        tr:hover { background: #f0e8f5; }
                        .center { text-align: center; }
                        .grade-cell { font-weight: 700; color: #5B2C83; font-size: 14px; }
                        .avg-row { background: #5B2C83 !important; color: white; }
                        .avg-row td { color: white; font-weight: 700; font-size: 13px; }
                        .avg-value { font-size: 18px; }
                        
                        .footer { margin-top: 25px; text-align: center; font-size: 9px; color: #999; border-top: 1px solid #eee; padding-top: 10px; }
                        .print-btn { background: #5B2C83; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; margin-bottom: 20px; }
                        .print-btn:hover { background: #7B4CA3; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <button class="print-btn no-print" onclick="window.print()">ğŸ–¨ï¸ Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· / Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· PDF</button>
                    
                    <div class="header">
                        <h1>ÎœÎŸÎ¥Î£Î™ÎšÎŸ Î£Î§ÎŸÎ›Î•Î™ÎŸ Î›Î•Î¥ÎšÎ‘Î”Î‘Î£</h1>
                        <h2>ÎšÎ±ÏÏ„Î­Î»Î± ÎœÎ±Î¸Î·Ï„Î® - Î¤ÎµÎ»Î¹ÎºÎ¿Î¯ Î’Î±Î¸Î¼Î¿Î¯</h2>
                    </div>
                    
                    <div class="student-info">
                        <h3>${student.name}</h3>
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Î¤Î¬Î¾Î·:</span> <span class="info-value">${className}</span></div>
                            <div class="info-item"><span class="info-label">Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…:</span> <span class="info-value">${student.regNo}</span></div>
                            <div class="info-item"><span class="info-label">Î£Ï‡Î¿Î»Î¹ÎºÏŒ ÎˆÏ„Î¿Ï‚:</span> <span class="info-value">2025-2026</span></div>
                            <div class="info-item"><span class="info-label">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±:</span> <span class="info-value">${new Date().toLocaleDateString('el-GR')}</span></div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width:60%">ÎœÎ¬Î¸Î·Î¼Î±</th>
                                <th style="width:20%" class="center">Î¤ÎµÎ»Î¹ÎºÏŒÏ‚ Î’Î±Î¸Î¼ÏŒÏ‚</th>
                                <th style="width:20%" class="center">Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map(r => `
                                <tr>
                                    <td>${r.sub}</td>
                                    <td class="center grade-cell">${r.display}</td>
                                    <td class="center">${r.num !== null && r.num >= 18 ? 'â­ Î†ÏÎ¹ÏƒÏ„Î±' : r.num !== null && r.num >= 15 ? 'âœ“ Î Î¿Î»Ï ÎšÎ±Î»Î¬' : ''}</td>
                                </tr>
                            `).join('')}
                            <tr class="avg-row">
                                <td style="text-align: right;"><strong>Î“Î•ÎÎ™ÎšÎŸÎ£ ÎœÎ•Î£ÎŸÎ£ ÎŸÎ¡ÎŸÎ£</strong></td>
                                <td class="center avg-value">${avg === null ? '-' : avg.toFixed(1)}</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·Ï‚: ${new Date().toLocaleDateString('el-GR')} | Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î¹Î¿ - ÎœÏ€Î¯Î¶Î¿Ï… Î”Î¹Î¿Î½Ï…ÏƒÎ¯Î±
                    </div>
                </body>
                </html>
            `);
            reportWindow.document.close();
            showToast('âœ“ Î— ÎºÎ±ÏÏ„Î­Î»Î± Ï„ÎµÎ»Î¹ÎºÏÎ½ Î²Î±Î¸Î¼ÏÎ½ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ!');
            closeModal();
        }

        function createClassFinalReport() {
            const classId = document.getElementById('report-class-final')?.value;
            if (!classId) {
                showToast('Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·');
                return;
            }
            const className = classes.find(c => c.id === classId)?.name || '';
            const classStudents = students.filter(s => s.classId === classId);

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Î¤ÎµÎ»Î¹ÎºÎ¿Î¯ Î’Î±Î¸Î¼Î¿Î¯ Î¤Î¬Î¾Î·Ï‚ - ${className}</title>
                    <style>
                        @page { size: A4 landscape; margin: 10mm; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 9px; padding: 15px; color: #333; }
                        .header { text-align: center; border-bottom: 3px solid #5B2C83; padding-bottom: 12px; margin-bottom: 15px; }
                        .header h1 { color: #5B2C83; font-size: 16px; margin-bottom: 5px; }
                        .header h2 { color: #666; font-size: 12px; font-weight: normal; }
                        .class-badge { display: inline-block; background: #5B2C83; color: white; padding: 5px 15px; border-radius: 20px; font-weight: 600; margin-top: 8px; }
                        
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th { background: #5B2C83; color: white; padding: 8px 5px; font-weight: 600; font-size: 8px; }
                        td { padding: 6px 5px; border-bottom: 1px solid #e8d5f2; font-size: 9px; text-align: center; }
                        tr:nth-child(even) { background: #faf8fc; }
                        tr:hover { background: #f0e8f5; }
                        .student-name { text-align: left !important; font-weight: 500; }
                        .grade-cell { font-weight: 600; color: #5B2C83; }
                        .avg-cell { background: #e8d5f2; font-weight: 700; color: #5B2C83; }
                        .high-grade { color: #27ae60; }
                        .low-grade { color: #e74c3c; }
                        
                        .footer { margin-top: 15px; text-align: center; font-size: 8px; color: #999; border-top: 1px solid #eee; padding-top: 8px; }
                        .print-btn { background: #5B2C83; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; margin-bottom: 15px; }
                        .print-btn:hover { background: #7B4CA3; }
                        @media print { .no-print { display: none; } }
                        .legend { margin-top: 10px; font-size: 8px; color: #666; }
                        .legend span { margin-right: 15px; }
                    </style>
                </head>
                <body>
                    <button class="print-btn no-print" onclick="window.print()">ğŸ–¨ï¸ Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· / Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· PDF</button>
                    
                    <div class="header">
                        <h1>ÎœÎŸÎ¥Î£Î™ÎšÎŸ Î£Î§ÎŸÎ›Î•Î™ÎŸ Î›Î•Î¥ÎšÎ‘Î”Î‘Î£</h1>
                        <h2>ÎšÎ±ÏÏ„Î­Î»Î± Î¤Î¬Î¾Î·Ï‚ - Î¤ÎµÎ»Î¹ÎºÎ¿Î¯ Î’Î±Î¸Î¼Î¿Î¯ ÎˆÏ„Î¿Ï…Ï‚</h2>
                        <div class="class-badge">${className}</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width:5%">Î‘.Îœ.</th>
                                <th style="width:20%">ÎœÎ±Î¸Î·Ï„Î®Ï‚</th>
                                ${subjects.map(sub => `<th>${sub}</th>`).join('')}
                                <th style="width:8%">Îœ.ÎŸ.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${classStudents.map(st => {
                                const finalKey = classId + '_' + st.regNo;
                                let nums = [];
                                let subjectCells = subjects.map(sub => {
                                    const raw = getLatestFinalFromDb(classId, st.regNo, sub);
                                    const num = (raw === undefined || raw === null || raw === '') ? null : parseFloat(String(raw).replace(',', '.'));
                                    if (num !== null && !Number.isNaN(num)) nums.push(num);
                                    const display = (num === null || Number.isNaN(num)) ? '-' : (Number.isInteger(num) ? String(num) : num.toFixed(1).replace('.', ','));
                                    const safe = escapeHtml(display);
                                    return `<td style="text-align:center;">${safe}</td>`;
                                }).join('');
                                
                                const avg = nums.length ? (nums.reduce((a,b)=>a+b,0) / nums.length) : null;
                                return `
                                    <tr>
                                        <td>${st.regNo}</td>
                                        <td class="student-name">${st.name}</td>
                                        ${subjectCells}
                                        <td class="avg-cell">${avg === null ? '-' : avg.toFixed(1)}</td>
                                    </tr>
                                `;
                            }).join('')}
                            ${!classStudents.length ? `<tr><td colspan="${3 + subjects.length}">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î¼Î±Î¸Î·Ï„Î­Ï‚.</td></tr>` : ''}
                        </tbody>
                    </table>
                    
                    <div class="legend">
                        <span>ğŸŸ¢ Î ÏÎ¬ÏƒÎ¹Î½Î¿: â‰¥18 (Î†ÏÎ¹ÏƒÏ„Î±)</span>
                        <span>ğŸ”´ ÎšÏŒÎºÎºÎ¹Î½Î¿: <10 (Î‘Î½ÎµÏ€Î±ÏÎºÎ®Ï‚)</span>
                    </div>
                    
                    <div class="footer">
                        Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·Ï‚: ${new Date().toLocaleDateString('el-GR')} | Î£Ï‡Î¿Î»Î¹ÎºÏŒ ÎˆÏ„Î¿Ï‚: 2025-2026 | Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î¹Î¿ - ÎœÏ€Î¯Î¶Î¿Ï… Î”Î¹Î¿Î½Ï…ÏƒÎ¯Î±
                    </div>
                </body>
                </html>
            `);
            reportWindow.document.close();
            showToast('âœ“ Î— ÎºÎ±ÏÏ„Î­Î»Î± Ï„Î¬Î¾Î·Ï‚ (Ï„ÎµÎ»Î¹ÎºÎ¿Î¯) Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ!');
            closeModal();
        }

function createStudentReport() {
            const classId = document.getElementById('report-class').value;
            const studentRegNo = document.getElementById('report-student').value;
            
            if (!classId || !studentRegNo) {
                showToast('Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î· ÎºÎ±Î¹ Î¼Î±Î¸Î·Ï„Î®');
                return;
            }

            
            const reportGrades = getGradesForReports();
const student = students.find(s => s.regNo === studentRegNo && s.classId === classId);
            const className = classes.find(c => c.id === classId)?.name;
            const studentGrades = reportGrades.filter(g => g.studentRegNo === studentRegNo && g.classId === classId);
            const allClassGrades = reportGrades.filter(g => g.classId === classId);
            const finalKey = `${classId}_${studentRegNo}`;
            
            // Helper function
            const calcAvg = (arr) => {
                if (arr.length === 0) return '-';
                const normalized = arr.map(g => g.scale === 100 ? g.score / 5 : g.score);
                return (normalized.reduce((a, b) => a + b, 0) / normalized.length).toFixed(1);
            };

            // Build detailed subject data with grades and notes
            const subjectData = subjects.map(subject => {
                const subjectGrades = studentGrades.filter(g => g.subject === subject);
                const classSubjectGrades = allClassGrades.filter(g => g.subject === subject);
                
                // Group grades by category with dates and notes
                const gradeDetails = [];
                categories.forEach(cat => {
                    const catGrades = subjectGrades.filter(g => g.category === cat);
                    catGrades.forEach(g => {
                        if (g.notes && g.notes.trim()) {
                            gradeDetails.push({
                                category: cat,
                                date: new Date(g.date).toLocaleDateString('el-GR'),
                                score: g.score + (g.scale === 100 ? '/100' : ''),
                                notes: g.notes
                            });
                        }
                    });
                });

                return {
                    subject,
                    studentAvg: calcAvg(subjectGrades.filter(g => g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£' && !g.category.includes('Î¤ÏÎ¯Î¼Î·Î½Î¿') && !g.category.includes('Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿') && !g.category.includes('ÎˆÏ„Î¿Ï…Ï‚'))),
                    classAvg: calcAvg(classSubjectGrades.filter(g => g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£' && !g.category.includes('Î¤ÏÎ¯Î¼Î·Î½Î¿') && !g.category.includes('Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿') && !g.category.includes('ÎˆÏ„Î¿Ï…Ï‚'))),
                    examScore: subjectGrades.filter(g => g.category === 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£').length > 0 
                        ? subjectGrades.filter(g => g.category === 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£').slice(-1)[0].score 
                        : '-',
                    trimesterFinal: getFinalGrade(classId, studentRegNo, subject, 'trimester') || '-',
                    tetramesterFinal: getFinalGrade(classId, studentRegNo, subject, 'tetramester') || '-',
                    yearFinal: getFinalGrade(classId, studentRegNo, subject, 'year') || '-',
                    gradeDetails
                };
            });

            // Overall averages
            const overallStudentAvg = calcAvg(studentGrades.filter(g => g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£'));
            const overallClassAvg = calcAvg(allClassGrades.filter(g => g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£'));

            // Generate PDF
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Î‘Ï„Î¿Î¼Î¹ÎºÏŒ Î”ÎµÎ»Ï„Î¯Î¿ - ${student.name}</title>
                    <style>
                        @page { size: A4; margin: 12mm; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 10px; padding: 15px; color: #333; }
                        .header { text-align: center; border-bottom: 3px solid #5B2C83; padding-bottom: 12px; margin-bottom: 15px; }
                        .header h1 { color: #5B2C83; font-size: 16px; margin-bottom: 5px; }
                        .header h2 { color: #666; font-size: 12px; font-weight: normal; }
                        .student-info { background: #f8f5fc; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
                        .student-info h3 { color: #5B2C83; font-size: 14px; margin-bottom: 8px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
                        .info-item { font-size: 10px; }
                        .info-label { color: #666; }
                        .info-value { font-weight: 600; }
                        
                        .subject-section { margin-bottom: 12px; page-break-inside: avoid; }
                        .subject-header { background: #5B2C83; color: white; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; }
                        .subject-name { font-weight: 700; font-size: 11px; }
                        .subject-stats { display: flex; gap: 15px; font-size: 10px; }
                        .stat-item { display: flex; flex-direction: column; align-items: center; }
                        .stat-value { font-weight: 700; font-size: 14px; }
                        .stat-label { font-size: 8px; opacity: 0.8; }
                        
                        .notes-table { width: 100%; border-collapse: collapse; font-size: 9px; }
                        .notes-table th { background: #e8d5f2; color: #5B2C83; padding: 6px 8px; text-align: left; font-weight: 600; }
                        .notes-table td { padding: 6px 8px; border-bottom: 1px solid #eee; }
                        .notes-table tr:nth-child(even) { background: #fafafa; }
                        .no-notes { color: #999; font-style: italic; padding: 10px; text-align: center; background: #fafafa; }
                        
                        .summary-section { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
                        .summary-box { background: #f8f5fc; padding: 12px; border-radius: 8px; text-align: center; }
                        .summary-box.highlight { background: #5B2C83; color: white; }
                        .summary-value { font-size: 20px; font-weight: 700; color: #5B2C83; }
                        .summary-box.highlight .summary-value { color: white; }
                        .summary-label { font-size: 9px; color: #666; margin-top: 3px; }
                        .summary-box.highlight .summary-label { color: rgba(255,255,255,0.8); }
                        .footer { margin-top: 15px; text-align: center; font-size: 8px; color: #999; border-top: 1px solid #eee; padding-top: 8px; }
                        
                        .exam-badge { background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
                        .final-badge { background: #5B2C83; color: white; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ÎœÎŸÎ¥Î£Î™ÎšÎŸ Î£Î§ÎŸÎ›Î•Î™ÎŸ Î›Î•Î¥ÎšÎ‘Î”Î‘Î£</h1>
                        <h2>Î‘Ï„Î¿Î¼Î¹ÎºÏŒ Î”ÎµÎ»Ï„Î¯Î¿ Î ÏÎ¿ÏŒÎ´Î¿Ï… ÎœÎ±Î¸Î·Ï„Î®</h2>
                    </div>
                    
                    <div class="student-info">
                        <h3>${student.name}</h3>
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Î¤Î¬Î¾Î·:</span> <span class="info-value">${className}</span></div>
                            <div class="info-item"><span class="info-label">Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…:</span> <span class="info-value">${student.regNo}</span></div>
                            <div class="info-item"><span class="info-label">Î£Ï‡Î¿Î»Î¹ÎºÏŒ ÎˆÏ„Î¿Ï‚:</span> <span class="info-value">2025-2026</span></div>
                            <div class="info-item"><span class="info-label">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±:</span> <span class="info-value">${new Date().toLocaleDateString('el-GR')}</span></div>
                        </div>
                    </div>

                    ${subjectData.map(s => `
                        <div class="subject-section">
                            <div class="subject-header">
                                <span class="subject-name">${s.subject}</span>
                                <div class="subject-stats">
                                    <div class="stat-item">
                                        <span class="stat-value">${s.studentAvg}</span>
                                        <span class="stat-label">Îœ.ÎŸ. ÎœÎ±Î¸Î·Ï„Î®</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-value">${s.classAvg}</span>
                                        <span class="stat-label">Îœ.ÎŸ. Î¤Î¬Î¾Î·Ï‚</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="exam-badge">${s.examScore}</span>
                                        <span class="stat-label">Î•Î¾ÎµÏ„Î¬ÏƒÎµÎ¹Ï‚</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="final-badge">${s.yearFinal}</span>
                                        <span class="stat-label">Î¤ÎµÎ»Î¹ÎºÏŒÏ‚</span>
                                    </div>
                                </div>
                            </div>
                            ${s.gradeDetails.length > 0 ? `
                                <table class="notes-table">
                                    <thead>
                                        <tr>
                                            <th style="width:20%">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</th>
                                            <th style="width:15%">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
                                            <th style="width:10%">Î’Î±Î¸Î¼ÏŒÏ‚</th>
                                            <th>Î£Ï‡ÏŒÎ»Î¹Î±</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${s.gradeDetails.map(d => `
                                            <tr>
                                                <td>${d.category}</td>
                                                <td>${d.date}</td>
                                                <td><strong>${d.score}</strong></td>
                                                <td>${d.notes}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<div class="no-notes">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ‡ÏŒÎ»Î¹Î± Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Î¼Î¬Î¸Î·Î¼Î±</div>'}
                        </div>
                    `).join('')}

                    <div class="summary-section">
                        <div class="summary-box">
                            <div class="summary-value">${overallStudentAvg}</div>
                            <div class="summary-label">Î“Î•ÎÎ™ÎšÎŸÎ£ Îœ.ÎŸ. ÎœÎ‘Î˜Î—Î¤Î—</div>
                        </div>
                        <div class="summary-box">
                            <div class="summary-value">${overallClassAvg}</div>
                            <div class="summary-label">Î“Î•ÎÎ™ÎšÎŸÎ£ Îœ.ÎŸ. Î¤Î‘ÎÎ—Î£</div>
                        </div>
                        <div class="summary-box highlight">
                            <div class="summary-value">${parseFloat(overallStudentAvg) > parseFloat(overallClassAvg) ? 'â†‘' : parseFloat(overallStudentAvg) < parseFloat(overallClassAvg) ? 'â†“' : '='}</div>
                            <div class="summary-label">Î£Î¥Î“ÎšÎ¡Î™Î£Î—</div>
                        </div>
                    </div>

                    <div class="footer">
                        Î•ÎºÏ„Ï…Ï€ÏÎ¸Î·ÎºÎµ: ${new Date().toLocaleString('el-GR')} | Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î¹Î¿ - ÎœÏ€Î¯Î¶Î¿Ï… Î”Î¹Î¿Î½Ï…ÏƒÎ¯Î±
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            reportWindow.document.close();
            
            showToast('âœ“ Î¤Î¿ Î´ÎµÎ»Ï„Î¯Î¿ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ!');
            closeModal();
        }

        function createClassReport() {
            const classId = document.getElementById('report-class-only').value;
            if (!classId) {
                showToast('Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·');
                return;
            }

            
            const reportGrades = getGradesForReports();
const className = classes.find(c => c.id === classId)?.name;
            const classStudents = students
                .filter(s => s.classId === classId)
                .sort((a, b) => a.name.localeCompare(b.name, 'el'));
            
            const allClassGrades = reportGrades.filter(g => g.classId === classId);

            const calcAvg = (arr) => {
                if (arr.length === 0) return '-';
                const normalized = arr.map(g => g.scale === 100 ? g.score / 5 : g.score);
                return (normalized.reduce((a, b) => a + b, 0) / normalized.length).toFixed(1);
            };

            // Calculate CLASS averages (Îœ.ÎŸ. Î¤Î¼Î®Î¼Î±Ï„Î¿Ï‚)
            const classTrimesterGrades = allClassGrades.filter(g => {
                const gDate = new Date(g.date);
                return gDate >= new Date('2025-09-01') && gDate <= new Date('2025-12-31') && g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£';
            });
            const classTetramesterGrades = allClassGrades.filter(g => {
                const gDate = new Date(g.date);
                return gDate >= new Date('2026-01-01') && gDate <= new Date('2026-05-31') && g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£';
            });
            const classExamGrades = allClassGrades.filter(g => g.category === 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£');

            const classTrimesterAvg = calcAvg(classTrimesterGrades);
            const classTetramesterAvg = calcAvg(classTetramesterGrades);
            const classExamAvg = calcAvg(classExamGrades);

            // Calculate stats for each student by period
            const studentStats = classStudents.map(student => {
                const studentGrades = reportGrades.filter(g => g.studentRegNo === student.regNo && g.classId === classId);
                const finalKey = `${classId}_${student.regNo}`;
                
                const trimesterGrades = studentGrades.filter(g => {
                    const gDate = new Date(g.date);
                    return gDate >= new Date('2025-09-01') && gDate <= new Date('2025-12-31') && g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£';
                });
                const tetramesterGrades = studentGrades.filter(g => {
                    const gDate = new Date(g.date);
                    return gDate >= new Date('2026-01-01') && gDate <= new Date('2026-05-31') && g.category !== 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£';
                });
                const examGrades = studentGrades.filter(g => g.category === 'Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£');

                // Get manual final grades (average across all subjects)
                let trimesterFinal = '-';
                let tetramesterFinal = '-';
                let yearFinal = '-';
                
                const fg = finalGrades[finalKey] || {};
                const trimesterFinals = subjects.map(s => parseFloat(fg[`${s}_trimester`])).filter(v => !isNaN(v));
                const tetramesterFinals = subjects.map(s => parseFloat(fg[`${s}_tetramester`])).filter(v => !isNaN(v));
                const yearFinals = subjects.map(s => parseFloat(fg[`${s}_year`])).filter(v => !isNaN(v));
                
                if (trimesterFinals.length > 0) {
                    trimesterFinal = (trimesterFinals.reduce((a, b) => a + b, 0) / trimesterFinals.length).toFixed(1);
                }
                if (tetramesterFinals.length > 0) {
                    tetramesterFinal = (tetramesterFinals.reduce((a, b) => a + b, 0) / tetramesterFinals.length).toFixed(1);
                }
                if (yearFinals.length > 0) {
                    yearFinal = (yearFinals.reduce((a, b) => a + b, 0) / yearFinals.length).toFixed(1);
                }

                // Exam average
                const examAvg = calcAvg(examGrades);

                return {
                    name: student.name,
                    regNo: student.regNo,
                    trimesterAvg: calcAvg(trimesterGrades),
                    trimesterFinal,
                    tetramesterAvg: calcAvg(tetramesterGrades),
                    tetramesterFinal,
                    examAvg,
                    yearFinal
                };
            });

            // Generate PDF
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¤Î¬Î¾Î·Ï‚ - ${className}</title>
                    <style>
                        @page { size: A4 landscape; margin: 8mm; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 9px; padding: 12px; color: #333; }
                        .header { text-align: center; border-bottom: 3px solid #5B2C83; padding-bottom: 8px; margin-bottom: 12px; }
                        .header h1 { color: #5B2C83; font-size: 15px; margin-bottom: 4px; }
                        .header h2 { color: #666; font-size: 11px; font-weight: normal; }
                        table { width: 100%; border-collapse: collapse; font-size: 8px; }
                        th { background: #5B2C83; color: white; padding: 6px 3px; text-align: center; font-weight: 600; }
                        th:first-child, th:nth-child(2) { text-align: left; }
                        td { padding: 6px 3px; border-bottom: 1px solid #ddd; text-align: center; }
                        td:first-child, td:nth-child(2) { text-align: left; }
                        tr:nth-child(even) { background: #fafafa; }
                        tr:hover { background: #f8f5fc; }
                        .period-header { background: #e8d5f2 !important; color: #5B2C83 !important; }
                        .avg-col { font-weight: 600; }
                        .class-avg-col { font-weight: 600; color: #666; background: #f0f0f0 !important; }
                        .final-col { font-weight: 700; color: #5B2C83; background: #f8f5fc !important; }
                        .exam-col { background: #fff3cd !important; color: #856404 !important; font-weight: 600; }
                        .year-col { background: #5B2C83 !important; color: white !important; font-weight: 700; }
                        .footer { margin-top: 12px; text-align: center; font-size: 7px; color: #999; border-top: 1px solid #eee; padding-top: 8px; }
                        .class-avg-row { background: #e8d5f2 !important; font-weight: 700; }
                        .class-avg-row td { border-top: 2px solid #5B2C83; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ÎœÎŸÎ¥Î£Î™ÎšÎŸ Î£Î§ÎŸÎ›Î•Î™ÎŸ Î›Î•Î¥ÎšÎ‘Î”Î‘Î£</h1>
                        <h2>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¤Î¬Î¾Î·Ï‚: ${className} - Î£Ï‡Î¿Î»Î¹ÎºÏŒ ÎˆÏ„Î¿Ï‚ 2025-2026</h2>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th rowspan="2" style="width:4%">Î‘/Î‘</th>
                                <th rowspan="2" style="width:18%">ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ</th>
                                <th colspan="3" class="period-header">Î‘Î„ Î¤Î¡Î™ÎœÎ—ÎÎŸ</th>
                                <th colspan="3" class="period-header">Î’Î„ Î¤Î•Î¤Î¡Î‘ÎœÎ—ÎÎŸ</th>
                                <th rowspan="2" class="exam-col" style="width:8%">Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£</th>
                                <th rowspan="2" class="year-col" style="width:9%">Î¤Î•Î›Î™ÎšÎŸÎ£ Î•Î¤ÎŸÎ¥Î£</th>
                            </tr>
                            <tr>
                                <th style="background:#f0e6f5;color:#5B2C83;">Îœ.ÎŸ.Îœ.</th>
                                <th style="background:#e0e0e0;color:#666;">Îœ.ÎŸ.Î¤.</th>
                                <th style="background:#f0e6f5;color:#5B2C83;">Î’Î±Î¸Î¼ÏŒÏ‚</th>
                                <th style="background:#f0e6f5;color:#5B2C83;">Îœ.ÎŸ.Îœ.</th>
                                <th style="background:#e0e0e0;color:#666;">Îœ.ÎŸ.Î¤.</th>
                                <th style="background:#f0e6f5;color:#5B2C83;">Î’Î±Î¸Î¼ÏŒÏ‚</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentStats.map((s, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${s.name}</td>
                                    <td class="avg-col">${s.trimesterAvg}</td>
                                    <td class="class-avg-col">${classTrimesterAvg}</td>
                                    <td class="final-col">${s.trimesterFinal}</td>
                                    <td class="avg-col">${s.tetramesterAvg}</td>
                                    <td class="class-avg-col">${classTetramesterAvg}</td>
                                    <td class="final-col">${s.tetramesterFinal}</td>
                                    <td class="exam-col">${s.examAvg}</td>
                                    <td class="year-col">${s.yearFinal}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="footer">
                        Îœ.ÎŸ.Îœ. = ÎœÎ­ÏƒÎ¿Ï‚ ÎŒÏÎ¿Ï‚ ÎœÎ±Î¸Î·Ï„Î® | Îœ.ÎŸ.Î¤. = ÎœÎ­ÏƒÎ¿Ï‚ ÎŒÏÎ¿Ï‚ Î¤Î¼Î®Î¼Î±Ï„Î¿Ï‚ | Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ${new Date().toLocaleDateString('el-GR')} | Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î¹Î¿ - ÎœÏ€Î¯Î¶Î¿Ï… Î”Î¹Î¿Î½Ï…ÏƒÎ¯Î±
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            reportWindow.document.close();
            
            showToast('âœ“ Î— ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ!');
            closeModal();
        }

        function createClassGridReport() {
            const classId = document.getElementById('report-class-grid').value;
            const subject = document.getElementById('report-subject-grid').value;
            
            if (!classId) {
                showToast('Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·');
                return;
            }

            
            const reportGrades = getGradesForReports();
const className = classes.find(c => c.id === classId)?.name;
            const classStudents = students
                .filter(s => s.classId === classId)
                .sort((a, b) => a.name.localeCompare(b.name, 'el'));

            // Get grades for each student
            const gridData = classStudents.map(student => {
                const studentGrades = reportGrades.filter(g => 
                    g.studentRegNo === student.regNo && 
                    g.classId === classId &&
                    (!subject || g.subject === subject)
                );
                const finalKey = `${classId}_${student.regNo}`;

                // Calculate averages per category (normalized to 0-20 scale)
                const getAvg = (cat) => {
                    const catGrades = studentGrades.filter(g => g.category === cat);
                    if (catGrades.length === 0) return '-';
                    // Normalize: if scale is 100, divide by 5 to get 0-20
                    const normalized = catGrades.map(g => g.scale === 100 ? g.score / 5 : g.score);
                    return (normalized.reduce((sum, s) => sum + s, 0) / normalized.length).toFixed(1);
                };

                // Get notes grouped by category
                const notesByCategory = {};
                categories.forEach(cat => {
                    const catGrades = studentGrades.filter(g => g.category === cat && g.notes && g.notes.trim());
                    if (catGrades.length > 0) {
                        notesByCategory[cat] = catGrades.map(g => ({
                            date: new Date(g.date).toLocaleDateString('el-GR'),
                            score: g.scale === 100 ? (g.score / 5).toFixed(1) : g.score,
                            note: g.notes
                        }));
                    }
                });

                const row = {
                    name: student.name,
                    regNo: student.regNo,
                    notesByCategory,
                    hasNotes: Object.keys(notesByCategory).length > 0,
                    Î”Î™Î‘Î“Î©ÎÎ™Î£ÎœÎ‘: getAvg('Î”Î™Î‘Î“Î©ÎÎ™Î£ÎœÎ‘'),
                    Î¤Î•Î£Î¤: getAvg('Î¤Î•Î£Î¤'),
                    Î Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ‘: getAvg('Î Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ‘'),
                    Î•Î¡Î“Î‘Î£Î™Î‘: getAvg('Î•Î¡Î“Î‘Î£Î™Î‘'),
                    Î¤Î•Î¤Î¡Î‘Î”Î™ÎŸ: getAvg('Î¤Î•Î¤Î¡Î‘Î”Î™ÎŸ'),
                    Î Î‘Î¡Î‘Î˜Î•ÎœÎ‘: getAvg('Î Î‘Î¡Î‘Î˜Î•ÎœÎ‘'),
                    Î Î‘Î¡Î‘Î“Î¡Î‘Î¦ÎŸÎ£: getAvg('Î Î‘Î¡Î‘Î“Î¡Î‘Î¦ÎŸÎ£'),
                    Î Î•Î¡Î™Î›Î—Î¨Î—: getAvg('Î Î•Î¡Î™Î›Î—Î¨Î—'),
                    Î•ÎšÎ˜Î•Î£Î—: getAvg('Î•ÎšÎ˜Î•Î£Î—'),
                    Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£: getAvg('Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£')
                };

                // Calculate M.O. from ALL categories (excluding exams), already normalized
                const allCatValues = [
                    row.Î”Î™Î‘Î“Î©ÎÎ™Î£ÎœÎ‘, row.Î¤Î•Î£Î¤, row.Î Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ‘, row.Î•Î¡Î“Î‘Î£Î™Î‘, 
                    row.Î¤Î•Î¤Î¡Î‘Î”Î™ÎŸ, row.Î Î‘Î¡Î‘Î˜Î•ÎœÎ‘, row.Î Î‘Î¡Î‘Î“Î¡Î‘Î¦ÎŸÎ£, row.Î Î•Î¡Î™Î›Î—Î¨Î—, row.Î•ÎšÎ˜Î•Î£Î—
                ].filter(v => v !== '-').map(v => parseFloat(v));

                if (allCatValues.length > 0) {
                    row.ÎœÎŸ = (allCatValues.reduce((a, b) => a + b, 0) / allCatValues.length).toFixed(1);
                } else {
                    row.ÎœÎŸ = '-';
                }

                // Get manual final grade (average across all subjects for this student)
                const fg = finalGrades[finalKey] || {};
                const yearFinals = subjects.map(s => parseFloat(fg[`${s}_year`])).filter(v => !isNaN(v));
                if (yearFinals.length > 0) {
                    row.Î¤Î•Î›Î™ÎšÎŸÎ£ = (yearFinals.reduce((a, b) => a + b, 0) / yearFinals.length).toFixed(1);
                } else {
                    row.Î¤Î•Î›Î™ÎšÎŸÎ£ = '-';
                }

                return row;
            });

            // Generate landscape PDF
            generateLandscapePDF(gridData, className, subject);
        }

        function generateLandscapePDF(data, className, subject) {
            // Create a new window with the report
            const reportWindow = window.open('', '_blank');
            const subjectTitle = subject || 'ÎŒÎ»Î± Ï„Î± Î¼Î±Î¸Î®Î¼Î±Ï„Î±';
            
            // Helper to render notes section
            const renderNotes = (notesByCategory) => {
                if (Object.keys(notesByCategory).length === 0) return '';
                
                let html = '<div class="notes-section">';
                for (const [cat, notes] of Object.entries(notesByCategory)) {
                    html += `<div class="note-category"><span class="note-cat-name">${cat}:</span>`;
                    notes.forEach(n => {
                        html += `<span class="note-item">[${n.date}] ${n.note}</span>`;
                    });
                    html += '</div>';
                }
                html += '</div>';
                return html;
            };
            
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Î Î¯Î½Î±ÎºÎ±Ï‚ Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±Ï‚ - ${className}</title>
                    <style>
                        @page { size: A4 landscape; margin: 8mm; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 8px; padding: 8px; }
                        .header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid #5B2C83; padding-bottom: 8px; }
                        .header h1 { color: #5B2C83; font-size: 14px; margin-bottom: 3px; }
                        .header p { color: #666; font-size: 10px; }
                        table { width: 100%; border-collapse: collapse; font-size: 7px; }
                        th { background: #5B2C83; color: white; padding: 5px 2px; text-align: center; font-weight: 600; font-size: 6px; }
                        th:first-child { text-align: left; min-width: 140px; }
                        td { padding: 4px 2px; border-bottom: 1px solid #ddd; text-align: center; font-size: 7px; }
                        td:first-child { text-align: left; font-weight: 500; }
                        tr:nth-child(even) { background: #f8f5fc; }
                        .exam-col { background: #fff3cd !important; color: #856404; font-weight: 600; }
                        .avg-col { background: #e8d5f2 !important; color: #5B2C83; font-weight: 600; }
                        .final-col { background: #5B2C83 !important; color: white !important; font-weight: 700; }
                        .footer { margin-top: 10px; text-align: right; font-size: 8px; color: #666; }
                        .no-grade { color: #ccc; }
                        
                        /* Notes styling */
                        .notes-row td { 
                            background: #fffef0 !important; 
                            border-bottom: 2px solid #5B2C83;
                            padding: 6px 8px;
                        }
                        .notes-section { 
                            text-align: left; 
                            font-size: 7px; 
                            line-height: 1.5;
                        }
                        .note-category { 
                            margin-bottom: 3px; 
                        }
                        .note-cat-name { 
                            font-weight: 700; 
                            color: #5B2C83; 
                            background: #e8d5f2;
                            padding: 1px 4px;
                            border-radius: 3px;
                            margin-right: 5px;
                        }
                        .note-item {
                            display: inline-block;
                            background: #f8f5fc;
                            padding: 2px 6px;
                            margin: 2px 3px;
                            border-radius: 3px;
                            border-left: 2px solid #5B2C83;
                        }
                        .student-row { border-top: 1px solid #ccc; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ÎœÎŸÎ¥Î£Î™ÎšÎŸ Î£Î§ÎŸÎ›Î•Î™ÎŸ Î›Î•Î¥ÎšÎ‘Î”Î‘Î£</h1>
                        <p><strong>${className}</strong> | ÎœÎ¬Î¸Î·Î¼Î±: ${subjectTitle} | Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ${new Date().toLocaleDateString('el-GR')}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ÎŸÎÎŸÎœÎ‘Î¤Î•Î Î©ÎÎ¥ÎœÎŸ</th>
                                <th>Î”Î™Î‘Î“.</th>
                                <th>Î¤Î•Î£Î¤</th>
                                <th>Î Î¡ÎŸÎ¦.</th>
                                <th>Î•Î¡Î“Î‘Î£.</th>
                                <th>Î¤Î•Î¤Î¡.</th>
                                <th>Î Î‘Î¡Î‘Î˜.</th>
                                <th>Î Î‘Î¡Î‘Î“Î¡.</th>
                                <th>Î Î•Î¡Î™Î›.</th>
                                <th>Î•ÎšÎ˜Î•Î£Î—</th>
                                <th class="avg-col">Îœ.ÎŸ.Îœ.</th>
                                <th class="exam-col">Î•ÎÎ•Î¤.</th>
                                <th class="final-col">Î¤Î•Î›Î™ÎšÎŸÎ£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(row => `
                                <tr class="student-row">
                                    <td>${row.name}</td>
                                    <td class="${row.Î”Î™Î‘Î“Î©ÎÎ™Î£ÎœÎ‘ === '-' ? 'no-grade' : ''}">${row.Î”Î™Î‘Î“Î©ÎÎ™Î£ÎœÎ‘}</td>
                                    <td class="${row.Î¤Î•Î£Î¤ === '-' ? 'no-grade' : ''}">${row.Î¤Î•Î£Î¤}</td>
                                    <td class="${row.Î Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ‘ === '-' ? 'no-grade' : ''}">${row.Î Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ‘}</td>
                                    <td class="${row.Î•Î¡Î“Î‘Î£Î™Î‘ === '-' ? 'no-grade' : ''}">${row.Î•Î¡Î“Î‘Î£Î™Î‘}</td>
                                    <td class="${row.Î¤Î•Î¤Î¡Î‘Î”Î™ÎŸ === '-' ? 'no-grade' : ''}">${row.Î¤Î•Î¤Î¡Î‘Î”Î™ÎŸ}</td>
                                    <td class="${row.Î Î‘Î¡Î‘Î˜Î•ÎœÎ‘ === '-' ? 'no-grade' : ''}">${row.Î Î‘Î¡Î‘Î˜Î•ÎœÎ‘}</td>
                                    <td class="${row.Î Î‘Î¡Î‘Î“Î¡Î‘Î¦ÎŸÎ£ === '-' ? 'no-grade' : ''}">${row.Î Î‘Î¡Î‘Î“Î¡Î‘Î¦ÎŸÎ£}</td>
                                    <td class="${row.Î Î•Î¡Î™Î›Î—Î¨Î— === '-' ? 'no-grade' : ''}">${row.Î Î•Î¡Î™Î›Î—Î¨Î—}</td>
                                    <td class="${row.Î•ÎšÎ˜Î•Î£Î— === '-' ? 'no-grade' : ''}">${row.Î•ÎšÎ˜Î•Î£Î—}</td>
                                    <td class="avg-col">${row.ÎœÎŸ}</td>
                                    <td class="exam-col">${row.Î•ÎÎ•Î¤Î‘Î£Î•Î™Î£}</td>
                                    <td class="final-col">${row.Î¤Î•Î›Î™ÎšÎŸÎ£}</td>
                                </tr>
                                ${row.hasNotes ? `
                                <tr class="notes-row">
                                    <td colspan="13">${renderNotes(row.notesByCategory)}</td>
                                </tr>
                                ` : ''}
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="footer">
                        Î•ÎºÏ„Ï…Ï€ÏÎ¸Î·ÎºÎµ: ${new Date().toLocaleString('el-GR')} | Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î¹Î¿ - ÎœÏ€Î¯Î¶Î¿Ï… Î”Î¹Î¿Î½Ï…ÏƒÎ¯Î±
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            reportWindow.document.close();
            
            showToast('âœ“ ÎŸ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ!');
            closeModal();
        }

        // ============== GOOGLE SHEETS SYNC ==============
        // NOTE: This implementation performs an invisible, non-blocking 'shadow sync' to Google Sheets
        // without changing the UI, reports, or existing storage flow.
        const GOOGLE_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw6wJJ1m5ZIg6wFGUDTGNmvtqAx2_h3JV0dYGAoPIuNeLo9wlpmthjt1Ba5xHIjCKfk/exec';
        const GOOGLE_SYNC_QUEUE_KEY = 'google_sync_queue_v1_staging';
        const GOOGLE_SYNC_TOKEN = 'tok_Dwhnci7Rx7kDgf24yVOLhE3YACHccNmd6Ejpb0e_5Mw';

        function getGoogleEndpointUrl() {
            const sep = GOOGLE_WEBAPP_URL.includes('?') ? '&' : '?';
            return GOOGLE_WEBAPP_URL + sep + 'token=' + encodeURIComponent(GOOGLE_SYNC_TOKEN);
        }

        function enqueueGoogleSync(payload) {
            try {
                const q = JSON.parse(localStorage.getItem(GOOGLE_SYNC_QUEUE_KEY) || '[]');
                const pid = String(payload && payload.id || '');
                const paction = String(payload && payload.action || '');
                const existingIdx = q.findIndex(x => String(x && x.id || '') === pid && String(x && x.action || '') === paction);
                if (existingIdx >= 0) {
                    // Latest wins (prevents duplicate rows if user taps twice or queue flush races)
                    q[existingIdx] = payload;
                } else {
                    q.push(payload);
                }
                // Optional safety cap
                if (q.length > 2000) q.splice(0, q.length - 2000);
                localStorage.setItem(GOOGLE_SYNC_QUEUE_KEY, JSON.stringify(q));
            } catch (e) {
                console.warn('Google sync queue error:', e);
            }
        }

        
        function markGradeSynced_(id) {
            try {
                const idx = grades.findIndex(g => String(g.id) === String(id));
                if (idx === -1) return;
                grades[idx].synced = true;
                grades[idx].syncedAt = new Date().toISOString();
                localStorage.setItem(GRADEBOOK_KEY, JSON.stringify(grades));
            } catch (e) {
                // no-op
            }
        }

async function flushGoogleSyncQueue() {
            // Best-effort: never block UI / saving flow
            if (!navigator.onLine) return;

            let q;
            try {
                q = JSON.parse(localStorage.getItem(GOOGLE_SYNC_QUEUE_KEY) || '[]');
            } catch (e) {
                return;
            }
            if (!Array.isArray(q) || q.length === 0) return;

            const remaining = [];

            for (const item of q) {
                try {
                    await fetch(getGoogleEndpointUrl(), {
                        method: 'POST',
                        // no-cors + NO custom headers => avoids CORS preflight (Apps Script cannot answer OPTIONS)
                        mode: 'no-cors',
                        body: JSON.stringify(item),
                        keepalive: true
                    });
                    if (item && item.id) { markGradeSynced_(item.id); }
                    // no-cors: response is opaque; assume success if no exception
                } catch (e) {
                    remaining.push(item);
                }
            }

            localStorage.setItem(GOOGLE_SYNC_QUEUE_KEY, JSON.stringify(remaining));

            // Hybrid: if everything pending is flushed, clear local history to prevent stale "Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ" on mobile
            if (HYBRID_CLEAR_LOCAL_ON_FULL_SYNC && remaining.length === 0) {
                try { localStorage.setItem('bizou_hide_synced_history','1'); } catch(e) {}
            }
        }

        
        function buildGooglePayload(grade, action) {
            if (!action) action = 'create';
            if (action === 'delete') {
                return { action: 'delete', id: String(grade.id) };
            }
            // Ensure the payload matches the sheet columns exactly
            return {
                action: action,
                id: String(grade.id),
                date: grade.date,
                savedAt: grade.savedAt || new Date().toISOString(),
                className: grade.className,
                studentName: grade.studentName,
                subject: grade.subject,
                category: grade.category,
                score: grade.score,
                scale: grade.scale,
                notes: grade.notes || ''
            };
        }

        async function syncToGoogleSheets(grade, action) {
            // If called without args (manual cloud button), just try flushing the queue
            if (!grade) {
                showToast('Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î¼Îµ Google Sheets...');
                await flushGoogleSyncQueue();
                showToast('âœ“ ÎˆÎ³Î¹Î½Îµ Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼Î¿Ï');
                return;
            }

            const payload = buildGooglePayload(grade, action);
            enqueueGoogleSync(payload);
            // Fire-and-forget; do not await
            flushGoogleSyncQueue();
        }

        window.addEventListener('load', () => {
            flushGoogleSyncQueue();
        });
        window.addEventListener('online', () => {
            flushGoogleSyncQueue();
        });

        function createPeriodReport() {
            const reportGrades = getGradesForReports();
            const period = document.getElementById('report-period').value;
            const periodNames = { '1': 'Î‘Î„ Î¤ÏÎ¯Î¼Î·Î½Î¿', '2': 'Î’Î„ Î¤ÎµÏ„ÏÎ¬Î¼Î·Î½Î¿' };
            const periodName = periodNames[period];

            // Filter grades by period date range
            const periodDates = periods.find(p => p.id === period);
            const periodGrades = reportGrades.filter(g => {
                const gDate = new Date(g.date);
                return gDate >= new Date(periodDates.start) && gDate <= new Date(periodDates.end);
            });

            const calcAvg = (arr) => {
                if (arr.length === 0) return '-';
                const normalized = arr.map(g => g.scale === 100 ? g.score / 5 : g.score);
                return (normalized.reduce((a, b) => a + b, 0) / normalized.length).toFixed(1);
            };

            // Overall statistics
            const totalGrades = periodGrades.length;
            const overallAvg = calcAvg(periodGrades);

            // Stats per class with categories and subjects breakdown
            const classData = classes.map(cls => {
                const classGrades = periodGrades.filter(g => g.classId === cls.id);
                const classStudentCount = students.filter(s => s.classId === cls.id).length;
                
                // Category stats for this class
                const categoryStats = categories.map(cat => {
                    const catGrades = classGrades.filter(g => g.category === cat);
                    return { category: cat, count: catGrades.length, average: calcAvg(catGrades) };
                }).filter(c => c.count > 0);

                // Subject stats for this class
                const subjectStats = subjects.map(subj => {
                    const subjGrades = classGrades.filter(g => g.subject === subj);
                    return { subject: subj, count: subjGrades.length, average: calcAvg(subjGrades) };
                }).filter(s => s.count > 0);

                return {
                    name: cls.name,
                    studentCount: classStudentCount,
                    gradeCount: classGrades.length,
                    average: calcAvg(classGrades),
                    categories: categoryStats,
                    subjects: subjectStats
                };
            });

            // Generate PDF
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Î‘Î½Î±Ï†Î¿ÏÎ¬ Î ÎµÏÎ¹ÏŒÎ´Î¿Ï… - ${periodName}</title>
                    <style>
                        @page { size: A4; margin: 12mm; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 9px; padding: 15px; color: #333; }
                        .header { text-align: center; border-bottom: 3px solid #5B2C83; padding-bottom: 10px; margin-bottom: 15px; }
                        .header h1 { color: #5B2C83; font-size: 16px; margin-bottom: 5px; }
                        .period-badge { display: inline-block; background: #5B2C83; color: white; padding: 5px 15px; border-radius: 20px; font-size: 11px; margin-top: 8px; }
                        .stats-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; }
                        .stat-box { background: #f8f5fc; padding: 12px 20px; border-radius: 8px; text-align: center; }
                        .stat-box.highlight { background: #5B2C83; color: white; }
                        .stat-value { font-size: 22px; font-weight: 700; color: #5B2C83; }
                        .stat-box.highlight .stat-value { color: white; }
                        .stat-label { font-size: 9px; color: #666; }
                        .stat-box.highlight .stat-label { color: rgba(255,255,255,0.8); }
                        .class-section { margin-bottom: 20px; page-break-inside: avoid; }
                        .class-header { background: #5B2C83; color: white; padding: 10px 15px; font-size: 12px; font-weight: 700; display: flex; justify-content: space-between; }
                        .class-body { border: 1px solid #e8d5f2; padding: 10px; }
                        .two-tables { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                        .mini-title { background: #e8d5f2; color: #5B2C83; padding: 5px 10px; font-size: 10px; font-weight: 600; margin-bottom: 5px; }
                        table { width: 100%; border-collapse: collapse; font-size: 8px; }
                        th { background: #f8f5fc; color: #5B2C83; padding: 5px; text-align: left; font-weight: 600; }
                        td { padding: 5px; border-bottom: 1px solid #eee; }
                        .avg-cell { font-weight: 700; color: #5B2C83; }
                        .footer { margin-top: 15px; text-align: center; font-size: 8px; color: #999; border-top: 1px solid #eee; padding-top: 8px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ÎœÎŸÎ¥Î£Î™ÎšÎŸ Î£Î§ÎŸÎ›Î•Î™ÎŸ Î›Î•Î¥ÎšÎ‘Î”Î‘Î£</h1>
                        <div class="period-badge">${periodName} - Î£Ï‡Î¿Î»Î¹ÎºÏŒ ÎˆÏ„Î¿Ï‚ 2025-2026</div>
                    </div>

                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-value">${students.length}</div>
                            <div class="stat-label">ÎœÎ±Î¸Î·Ï„Î­Ï‚</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${totalGrades}</div>
                            <div class="stat-label">Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î®ÏƒÎµÎ¹Ï‚</div>
                        </div>
                        <div class="stat-box highlight">
                            <div class="stat-value">${overallAvg}</div>
                            <div class="stat-label">Î“ÎµÎ½Î¹ÎºÏŒÏ‚ Îœ.ÎŸ.</div>
                        </div>
                    </div>

                    ${classData.map(cls => `
                        <div class="class-section">
                            <div class="class-header">
                                <span>${cls.name}</span>
                                <span>ÎœÎ±Î¸Î·Ï„Î­Ï‚: ${cls.studentCount} | Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î®ÏƒÎµÎ¹Ï‚: ${cls.gradeCount} | Îœ.ÎŸ.: ${cls.average}</span>
                            </div>
                            <div class="class-body">
                                <div class="two-tables">
                                    <div>
                                        <div class="mini-title">Î‘ÎÎ‘ ÎšÎ‘Î¤Î—Î“ÎŸÎ¡Î™Î‘</div>
                                        <table>
                                            <thead><tr><th>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</th><th>Î Î»Î®Î¸Î¿Ï‚</th><th>Îœ.ÎŸ.</th></tr></thead>
                                            <tbody>
                                                ${cls.categories.length > 0 ? cls.categories.map(c => `
                                                    <tr>
                                                        <td>${c.category}</td>
                                                        <td>${c.count}</td>
                                                        <td class="avg-cell">${c.average}</td>
                                                    </tr>
                                                `).join('') : '<tr><td colspan="3" style="text-align:center;color:#999;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div>
                                        <div class="mini-title">Î‘ÎÎ‘ ÎœÎ‘Î˜Î—ÎœÎ‘</div>
                                        <table>
                                            <thead><tr><th>ÎœÎ¬Î¸Î·Î¼Î±</th><th>Î Î»Î®Î¸Î¿Ï‚</th><th>Îœ.ÎŸ.</th></tr></thead>
                                            <tbody>
                                                ${cls.subjects.length > 0 ? cls.subjects.map(s => `
                                                    <tr>
                                                        <td>${s.subject}</td>
                                                        <td>${s.count}</td>
                                                        <td class="avg-cell">${s.average}</td>
                                                    </tr>
                                                `).join('') : '<tr><td colspan="3" style="text-align:center;color:#999;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}

                    <div class="footer">
                        Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·Ï‚: ${new Date().toLocaleString('el-GR')} | Î’Î±Î¸Î¼Î¿Î»ÏŒÎ³Î¹Î¿ - ÎœÏ€Î¯Î¶Î¿Ï… Î”Î¹Î¿Î½Ï…ÏƒÎ¯Î±
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            reportWindow.document.close();
            
            showToast('âœ“ Î— Î±Î½Î±Ï†Î¿ÏÎ¬ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ!');
            closeModal();
        }

        function closeModal() {
            document.getElementById('report-modal').classList.remove('active');
        }

        // Close modal on overlay click
        document.getElementById('report-modal').addEventListener('click', (e) => {
            if (e.target.id === 'report-modal') closeModal();
        });

        // ============== TOAST ==============
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // ============== PWA INSTALL ==============
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
    </script>
</body>
</html>
