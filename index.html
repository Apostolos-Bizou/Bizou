<script>
  // --- Frontend PIN lock ---
  const PIN = "4775";
  const KEY = "bizou_pin_session_ok";

  (function () {
    if (sessionStorage.getItem(KEY) === "1") return;
    const entered = prompt("Κωδικός πρόσβασης:");
    if (entered === null) {
      document.documentElement.innerHTML = "";
      throw new Error("Ακύρωση — δεν επιτρέπεται πρόσβαση.");
    }
    if (String(entered).trim() !== String(PIN).trim()) {
      document.documentElement.innerHTML = "";
      throw new Error("Λάθος κωδικός.");
    }
    sessionStorage.setItem(KEY, "1");
    function relock() { sessionStorage.removeItem(KEY); }
    document.addEventListener("visibilitychange", () => { if (document.hidden) relock(); });
    window.addEventListener("pagehide", relock);
    window.addEventListener("beforeunload", relock);
  })();

  // --- Constants ---
  const APP_BUILD = '2026-01-19-finalreports1';
  const HYBRID_CLEAR_LOCAL_ON_FULL_SYNC = true;
  const LOCAL_GRADES_KEY = 'bizou_grades';
  const LOCAL_SYNC_QUEUE_KEY = 'google_sync_queue_v1';
  const GRADEBOOK_KEY = 'bizou_gradebook_v1';
  const LEGACY_GRADEBOOK_KEY = 'bizou_grades';
  const HISTORY_HIDDEN_KEY = 'bizou_history_hidden_ids_v1';
  const FINAL_GRADES_KEY = 'bizou_final_grades';
  const SCHOOL_YEAR = '2025-2026';

  // --- Data ---
  const classes = [
    { id: "A1_LYK_2025_2026", name: "Α1 ΛΥΚΕΙΟΥ ΓΕΝΙΚΗΣ ΠΑΙΔΕΙΑΣ", year: "2025-2026" },
    { id: "A2_LYK_2025_2026", name: "Α2 ΛΥΚΕΙΟΥ ΓΕΝΙΚΗΣ ΠΑΙΔΕΙΑΣ", year: "2025-2026" },
    { id: "A1_GYM_2025_2026", name: "Α1 ΓΥΜΝΑΣΙΟΥ ΓΕΝΙΚΗΣ ΠΑΙΔΕΙΑΣ", year: "2025-2026" },
    { id: "A2_GYM_2025_2026", name: "Α2 ΓΥΜΝΑΣΙΟΥ ΓΕΝΙΚΗΣ ΠΑΙΔΕΙΑΣ", year: "2025-2026" },
    { id: "B1_GYM_2025_2026", name: "Β1 ΓΥΜΝΑΣΙΟΥ ΓΕΝΙΚΗΣ ΠΑΙΔΕΙΑΣ", year: "2025-2026" },
    { id: "B2_GYM_2025_2026", name: "Β2 ΓΥΜΝΑΣΙΟΥ ΓΕΝΙΚΗΣ ΠΑΙΔΕΙΑΣ", year: "2025-2026" }
  ];

  const students = [
    // (Κράτησε τους υπάρχοντες μαθητές)
  ];

  const subjects = ["ΟΔΥΣΣΕΙΑ", "ΑΡΧΑΙΑ", "ΙΣΤΟΡΙΑ", "ΓΛΩΣΣΑ"];
  const categories = ["ΔΙΑΓΩΝΙΣΜΑ", "ΤΕΣΤ", "ΠΡΟΦΟΡΙΚΑ", "ΕΡΓΑΣΙΑ", "ΤΕΤΡΑΔΙΟ", "ΠΑΡΑΘΕΜΑ", "ΠΑΡΑΓΡΑΦΟΣ", "ΠΕΡΙΛΗΨΗ", "ΕΚΘΕΣΗ", "ΕΞΕΤΑΣΕΙΣ"];
  const periods = [
    { id: '1', name: 'Α΄ Τρίμηνο', start: '2025-09-01', end: '2025-12-31' },
    { id: '2', name: 'Β΄ Τετράμηνο', start: '2026-01-01', end: '2026-05-31' }
  ];

  const commentPhrases = [
    { id: 1, category: "Θετικό", text: "Πολύ καλή προσπάθεια σήμερα." },
    { id: 2, category: "Θετικό", text: "Σαφής δομή και σωστή τεκμηρίωση." },
    { id: 3, category: "Βελτίωση", text: "Χρειάζεται περισσότερη προσοχή στην ανάλυση." },
    { id: 4, category: "Βελτίωση", text: "Να βελτιώσει την ορθογραφία/σημεία στίξης." },
    { id: 5, category: "Συμπεριφορά", text: "Συνεργάσιμος/η στην τάξη." },
    { id: 6, category: "Συμπεριφορά", text: "Απαιτείται καλύτερη συγκέντρωση κατά τη διάρκεια του μαθήματος." }
  ];

  // --- Gradebook ---
  let grades = loadGradebook_();
  let finalGrades = loadFinalGrades_();

  // --- Helpers ---
  function loadGradebook_() {
    let raw = localStorage.getItem(GRADEBOOK_KEY);
    if (!raw) raw = localStorage.getItem(LEGACY_GRADEBOOK_KEY);
    let arr;
    try { arr = JSON.parse(raw || '[]'); } catch(e) { arr = []; }
    arr = Array.isArray(arr) ? arr : [];
    arr = arr.map(g => ({...g, synced: (g && typeof g.synced === 'boolean') ? g.synced : false}));
    try { localStorage.setItem(GRADEBOOK_KEY, JSON.stringify(arr)); } catch(e) {}
    return arr;
  }

  function saveGradebook_() {
    try { localStorage.setItem(GRADEBOOK_KEY, JSON.stringify(grades)); } catch(e) {}
  }

  function loadFinalGrades_() {
    try { return JSON.parse(localStorage.getItem(FINAL_GRADES_KEY) || '{}'); }
    catch(e) { return {}; }
  }

  function getHiddenHistoryIds_() {
    try { const raw = localStorage.getItem(HISTORY_HIDDEN_KEY) || '[]'; const arr = JSON.parse(raw); return new Set(Array.isArray(arr) ? arr.map(String) : []); }
    catch(e) { return new Set(); }
  }

  function setHiddenHistoryIds_(set) {
    try { localStorage.setItem(HISTORY_HIDDEN_KEY, JSON.stringify(Array.from(set))); } catch(e) {}
  }

  // --- ID Generation (ΔΙΟΡΘΩΜΕΝΗ ΣΥΝΑΡΤΗΣΗ) ---
  function isFinalCategory(category) {
    const c = String(category || '').trim();
    return (
      c === 'Α΄ Τρίμηνο' || c === 'A΄ Τρίμηνο' || c === "Α' Τρίμηνο" || c === "A' Τρίμηνο" ||
      c === 'Β΄ Τετράμηνο' || c === 'B΄ Τετράμηνο' || c === "Β' Τετράμηνο" || c === "B' Τετράμηνο" ||
      c === 'Τελικός Έτους' || c === 'Τελικός Ετους' || c === 'Τελικός'
    );
  }

  function categoryToCode(category) {
    const c = String(category || '').trim();
    if (c.includes('Τρίμηνο')) return 'TRI';
    if (c.includes('Τετράμηνο') || c.includes('Τετραμηνο')) return 'TET';
    if (c.includes('Έτους') || c.includes('Ετους') || c === 'Τελικός') return 'YEAR';
    return c.toUpperCase().replace(/\s+/g, '_').slice(0, 12) || 'UNK';
  }

  function subjectToCode(subjectName) {
    const idx = subjects.indexOf(subjectName);
    return idx >= 0 ? `S${idx}` : 'SUNK';
  }

  function base64UrlEncode(str) {
    const b64 = btoa(unescape(encodeURIComponent(str)));
    return b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
  }

  // ΔΙΟΡΘΩΜΕΝΗ ΣΥΝΑΡΤΗΣΗ: Προσθήκη τυχαίου suffix για μοναδικότητα
  function makeGradeId({ classId, schoolYear, studentRegistryNo, subjectName, category, dateISO }) {
    if (isFinalCategory(category)) {
      return `FIN_${classId}_${schoolYear}_${studentRegistryNo}_${subjectToCode(subjectName)}_${categoryToCode(category)}`;
    }
    // Προσθήκη τυχαίου suffix για μοναδικότητα σε μαζική αποθήκευση
    const randomSuffix = Math.random().toString(36).substring(2, 8);
    return `GR_${classId}_${schoolYear}_${studentRegistryNo}_${subjectToCode(subjectName)}_${categoryToCode(category)}_${dateISO}_${randomSuffix}`;
  }

  // --- Save Grade (ΔΙΟΡΘΩΜΕΝΗ ΛΟΓΙΚΗ) ---
  function saveGrade() {
    const classId = document.getElementById('class-select').value;
    const schoolYear = SCHOOL_YEAR;
    const studentRegNo = document.getElementById('student-select').value;
    const subject = document.getElementById('subject-select').value;
    const category = document.getElementById('category-select').value;
    const notes = document.getElementById('notes-input').value;
    const selectedDate = document.getElementById('grade-date').value;

    let score, scale;
    if (currentScale === 100) {
      score = parseFloat(document.getElementById('score-slider-100').value);
      scale = 100;
    } else {
      score = parseFloat(document.getElementById('score-slider-20').value);
      scale = 20;
    }

    if (!classId || !studentRegNo || !subject || !category || !selectedDate) {
      showToast('Παρακαλώ συμπληρώστε όλα τα πεδία');
      return;
    }

    const student = students.find(s => s.regNo === studentRegNo && s.classId === classId);
    const className = classes.find(c => c.id === classId)?.name;

    // Δημιουργία μοναδικού ID
    const uniqueId = makeGradeId({
      classId, schoolYear, studentRegistryNo: studentRegNo,
      subjectName: subject, category, dateISO: selectedDate
    });

    const savedAt = new Date().toISOString();
    const grade = {
      id: uniqueId,
      classId, className, studentRegNo, studentName: student?.name,
      subject, category, score, scale, notes,
      date: selectedDate, savedAt, synced: false
    };

    grades.unshift(grade);
    saveGradebook_();
    syncToGoogleSheets(grade, 'upsert');

    // Reset form
    document.getElementById('student-select').value = '';
    document.getElementById('notes-input').value = '';
    document.getElementById('student-banner').classList.remove('visible');
    setScore20(10);
    setScore100(50);

    updateStats();
    updateLiveStats();
    renderRecentGrades();
    showToast('✓ Ο βαθμός αποθηκεύτηκε');
  }

  // --- Υπόλοιπες συναρτήσεις (κράτησε τις υπάρχουσες) ---
  // (Κράτησε όλες τις άλλες συναρτήσεις όπως είναι)
</script>
